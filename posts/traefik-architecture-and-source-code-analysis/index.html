<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Traefik Architecture and Source Code Analysis: A Deep Dive | zhoukuncheng's Personal Blog</title>
<meta name=keywords content="Golang,Traefik"><meta name=description content="Traefik is a widely adopted open-source HTTP reverse proxy and load balancer that simplifies the routing and load balancing of requests for modern web applications. It boasts dynamic configuration capabilities and supports a multitude of providers, positioning itself as a versatile solution for orchestrating complex deployment scenarios. In this blog post, we will delve into the architecture of Traefik and dissect the key components of its source code to furnish a more nuanced understanding of its operational mechanics.
Traefik Architecture: A High-Level Overview At its core, Traefik&rsquo;s architecture is composed of several integral components that collaborate to facilitate dynamic routing and load balancing:
Static Configuration: These are foundational settings for Traefik, encompassing entry points, providers, and API access configurations. They can be specified via file, command-line arguments, or environment variables.
Dynamic Configuration: This pertains to the routing rules, services, and middlewares that are adaptable based on the state of the infrastructure. Traefik&rsquo;s compatibility with a myriad of providers, such as Docker, Kubernetes, Consul Catalog, among others, underscores its dynamism.
Providers: Acting as the bridge between Traefik and service discovery mechanisms, providers are tasked with sourcing and conveying dynamic configuration to Traefik. Each provider is tailored to integrate with different technologies like Docker, Kubernetes, and Consul."><meta name=author content><link rel=canonical href=https://zhoukuncheng.github.io/posts/traefik-architecture-and-source-code-analysis/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://zhoukuncheng.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zhoukuncheng.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zhoukuncheng.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zhoukuncheng.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zhoukuncheng.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zhoukuncheng.github.io/posts/traefik-architecture-and-source-code-analysis/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-GH88YSLNJN"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GH88YSLNJN")}</script><meta property="og:title" content="Traefik Architecture and Source Code Analysis: A Deep Dive"><meta property="og:description" content="Traefik is a widely adopted open-source HTTP reverse proxy and load balancer that simplifies the routing and load balancing of requests for modern web applications. It boasts dynamic configuration capabilities and supports a multitude of providers, positioning itself as a versatile solution for orchestrating complex deployment scenarios. In this blog post, we will delve into the architecture of Traefik and dissect the key components of its source code to furnish a more nuanced understanding of its operational mechanics.
Traefik Architecture: A High-Level Overview At its core, Traefik&rsquo;s architecture is composed of several integral components that collaborate to facilitate dynamic routing and load balancing:
Static Configuration: These are foundational settings for Traefik, encompassing entry points, providers, and API access configurations. They can be specified via file, command-line arguments, or environment variables.
Dynamic Configuration: This pertains to the routing rules, services, and middlewares that are adaptable based on the state of the infrastructure. Traefik&rsquo;s compatibility with a myriad of providers, such as Docker, Kubernetes, Consul Catalog, among others, underscores its dynamism.
Providers: Acting as the bridge between Traefik and service discovery mechanisms, providers are tasked with sourcing and conveying dynamic configuration to Traefik. Each provider is tailored to integrate with different technologies like Docker, Kubernetes, and Consul."><meta property="og:type" content="article"><meta property="og:url" content="https://zhoukuncheng.github.io/posts/traefik-architecture-and-source-code-analysis/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-09T14:54:00+08:00"><meta property="article:modified_time" content="2024-03-09T14:54:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Traefik Architecture and Source Code Analysis: A Deep Dive"><meta name=twitter:description content="Traefik is a widely adopted open-source HTTP reverse proxy and load balancer that simplifies the routing and load balancing of requests for modern web applications. It boasts dynamic configuration capabilities and supports a multitude of providers, positioning itself as a versatile solution for orchestrating complex deployment scenarios. In this blog post, we will delve into the architecture of Traefik and dissect the key components of its source code to furnish a more nuanced understanding of its operational mechanics.
Traefik Architecture: A High-Level Overview At its core, Traefik&rsquo;s architecture is composed of several integral components that collaborate to facilitate dynamic routing and load balancing:
Static Configuration: These are foundational settings for Traefik, encompassing entry points, providers, and API access configurations. They can be specified via file, command-line arguments, or environment variables.
Dynamic Configuration: This pertains to the routing rules, services, and middlewares that are adaptable based on the state of the infrastructure. Traefik&rsquo;s compatibility with a myriad of providers, such as Docker, Kubernetes, Consul Catalog, among others, underscores its dynamism.
Providers: Acting as the bridge between Traefik and service discovery mechanisms, providers are tasked with sourcing and conveying dynamic configuration to Traefik. Each provider is tailored to integrate with different technologies like Docker, Kubernetes, and Consul."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zhoukuncheng.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Traefik Architecture and Source Code Analysis: A Deep Dive","item":"https://zhoukuncheng.github.io/posts/traefik-architecture-and-source-code-analysis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Traefik Architecture and Source Code Analysis: A Deep Dive","name":"Traefik Architecture and Source Code Analysis: A Deep Dive","description":"Traefik is a widely adopted open-source HTTP reverse proxy and load balancer that simplifies the routing and load balancing of requests for modern web applications. It boasts dynamic configuration capabilities and supports a multitude of providers, positioning itself as a versatile solution for orchestrating complex deployment scenarios. In this blog post, we will delve into the architecture of Traefik and dissect the key components of its source code to furnish a more nuanced understanding of its operational mechanics.\nTraefik Architecture: A High-Level Overview At its core, Traefik\u0026rsquo;s architecture is composed of several integral components that collaborate to facilitate dynamic routing and load balancing:\nStatic Configuration: These are foundational settings for Traefik, encompassing entry points, providers, and API access configurations. They can be specified via file, command-line arguments, or environment variables.\nDynamic Configuration: This pertains to the routing rules, services, and middlewares that are adaptable based on the state of the infrastructure. Traefik\u0026rsquo;s compatibility with a myriad of providers, such as Docker, Kubernetes, Consul Catalog, among others, underscores its dynamism.\nProviders: Acting as the bridge between Traefik and service discovery mechanisms, providers are tasked with sourcing and conveying dynamic configuration to Traefik. Each provider is tailored to integrate with different technologies like Docker, Kubernetes, and Consul.","keywords":["Golang","Traefik"],"articleBody":" Traefik is a widely adopted open-source HTTP reverse proxy and load balancer that simplifies the routing and load balancing of requests for modern web applications. It boasts dynamic configuration capabilities and supports a multitude of providers, positioning itself as a versatile solution for orchestrating complex deployment scenarios. In this blog post, we will delve into the architecture of Traefik and dissect the key components of its source code to furnish a more nuanced understanding of its operational mechanics.\nTraefik Architecture: A High-Level Overview At its core, Traefik’s architecture is composed of several integral components that collaborate to facilitate dynamic routing and load balancing:\nStatic Configuration: These are foundational settings for Traefik, encompassing entry points, providers, and API access configurations. They can be specified via file, command-line arguments, or environment variables.\nDynamic Configuration: This pertains to the routing rules, services, and middlewares that are adaptable based on the state of the infrastructure. Traefik’s compatibility with a myriad of providers, such as Docker, Kubernetes, Consul Catalog, among others, underscores its dynamism.\nProviders: Acting as the bridge between Traefik and service discovery mechanisms, providers are tasked with sourcing and conveying dynamic configuration to Traefik. Each provider is tailored to integrate with different technologies like Docker, Kubernetes, and Consul.\nEntry Points: These designate the network interfaces (ports and protocols) where Traefik listens for inbound traffic.\nRouters: Routers establish criteria for matching incoming requests by various parameters such as hostnames, paths, and headers. They are responsible for directing requests to the appropriate service.\nServices: Services define the mechanisms through which Traefik communicates with backend systems that process the requests. These can be fine-tuned with distinct load balancing strategies and health checks.\nMiddlewares: As modular entities, middlewares can be attached to routers or services, enabling a range of functions including authentication, rate limiting, and request modification.\nPlugins: Traefik can be extended with plugins, which augment its functionality. The plugin system empowers developers to contribute custom plugins.\nThe orchestration of these components is as follows:\nTraefik ingests the static configuration and begins monitoring the specified entry points. Providers perpetually scan the infrastructure for configuration changes, relaying them to Traefik via a dynamic configuration channel. Traefik processes the dynamic configuration, updating its internal constructs—routers, services, and middlewares—to reflect these changes. As requests come in, Traefik matches them against router rules and channels them to the designated service. Services apply their load balancing logic to distribute the request to a backend server. Middlewares may be invoked at various stages in the request/response lifecycle to perform their respective duties. This dynamic architecture enables Traefik to nimbly adjust to alterations within the infrastructure, automating the routing configuration in alignment with the deployed services.\nSource Code Analysis: Key Components Now, let’s examine some of the pivotal components within Traefik’s source code:\n1. Watcher and Listener:\nThe watcher and listener collaborate to detect and enact dynamic configuration changes. The watcher is in charge of incessantly surveying configuration sources and propelling updates to the listener. Subsequently, the listener validates these updates and integrates them with Traefik’s internal state.\nWatcher: pkg/server/configurationwatcher.go\n// NewConfigurationWatcher creates a new ConfigurationWatcher. func NewConfigurationWatcher( routinesPool *safe.Pool, pvd provider.Provider, defaultEntryPoints []string, requiredProvider string, ) *ConfigurationWatcher { return \u0026ConfigurationWatcher{ providerAggregator: pvd, allProvidersConfigs: make(chan dynamic.Message, 100), newConfigs: make(chan dynamic.Configurations), routinesPool: routinesPool, defaultEntryPoints: defaultEntryPoints, requiredProvider: requiredProvider, } } // Start the configuration watcher. func (c *ConfigurationWatcher) Start() { c.routinesPool.GoCtx(c.receiveConfigurations) c.routinesPool.GoCtx(c.applyConfigurations) c.startProviderAggregator() } // Stop the configuration watcher. func (c *ConfigurationWatcher) Stop() { close(c.allProvidersConfigs) close(c.newConfigs) } // AddListener adds a new listener function used when new configuration is provided. func (c *ConfigurationWatcher) AddListener(listener func(dynamic.Configuration)) { if c.configurationListeners == nil { c.configurationListeners = make([]func(dynamic.Configuration), 0) } c.configurationListeners = append(c.configurationListeners, listener) } func (c *ConfigurationWatcher) startProviderAggregator() { log.Info().Msgf(\"Starting provider aggregator %T\", c.providerAggregator) safe.Go(func() { err := c.providerAggregator.Provide(c.allProvidersConfigs, c.routinesPool) if err != nil { log.Error().Err(err).Msgf(\"Error starting provider aggregator %T\", c.providerAggregator) } }) } Listener: cmd/traefik/traefik.go\n// Server Transports watcher.AddListener(func(conf dynamic.Configuration) { roundTripperManager.Update(conf.HTTP.ServersTransports) dialerManager.Update(conf.TCP.ServersTransports) }) pkg/server/service/roundtripper.go\n// RoundTripperManager handles roundtripper for the reverse proxy. type RoundTripperManager struct { rtLock sync.RWMutex roundTrippers map[string]http.RoundTripper configs map[string]*dynamic.ServersTransport spiffeX509Source SpiffeX509Source } // Update updates the roundtrippers configurations. func (r *RoundTripperManager) Update(newConfigs map[string]*dynamic.ServersTransport) { r.rtLock.Lock() defer r.rtLock.Unlock() for configName, config := range r.configs { newConfig, ok := newConfigs[configName] if !ok { delete(r.configs, configName) delete(r.roundTrippers, configName) continue } if reflect.DeepEqual(newConfig, config) { continue } var err error r.roundTrippers[configName], err = r.createRoundTripper(newConfig) if err != nil { log.Error().Err(err).Msgf(\"Could not configure HTTP Transport %s, fallback on default transport\", configName) r.roundTrippers[configName] = http.DefaultTransport } } for newConfigName, newConfig := range newConfigs { if _, ok := r.configs[newConfigName]; ok { continue } var err error r.roundTrippers[newConfigName], err = r.createRoundTripper(newConfig) if err != nil { log.Error().Err(err).Msgf(\"Could not configure HTTP Transport %s, fallback on default transport\", newConfigName) r.roundTrippers[newConfigName] = http.DefaultTransport } } r.configs = newConfigs } 2. Provider:\nProviders are pivotal in Traefik’s architecture, interfacing with specific technologies to unearth and deliver configuration updates. The Provide function lies at the heart of the provider’s role, managing connection, discovery, and update processes.\nKubernetes Provider: Configuration Discovery\nThe Kubernetes provider within Traefik extracts configuration details from the Kubernetes API server, monitoring changes across Kubernetes resources like Ingress, IngressRoute, Service, and Middleware objects.\n2.1. Kubernetes Client Initialization:\nThe provider initializes a client to connect with the Kubernetes API, utilizing this client to engage with the API and observe resource changes.\npkg/provider/kubernetes/crd/kubernetes.go\nfunc (p *Provider) newK8sClient(ctx context.Context) (*clientWrapper, error) { _, err := labels.Parse(p.LabelSelector) if err != nil { return nil, fmt.Errorf(\"invalid label selector: %q\", p.LabelSelector) } log.Ctx(ctx).Info().Msgf(\"label selector is: %q\", p.LabelSelector) withEndpoint := \"\" if p.Endpoint != \"\" { withEndpoint = fmt.Sprintf(\" with endpoint %s\", p.Endpoint) } var client *clientWrapper switch { case os.Getenv(\"KUBERNETES_SERVICE_HOST\") != \"\" \u0026\u0026 os.Getenv(\"KUBERNETES_SERVICE_PORT\") != \"\": log.Ctx(ctx).Info().Msgf(\"Creating in-cluster Provider client%s\", withEndpoint) client, err = newInClusterClient(p.Endpoint) case os.Getenv(\"KUBECONFIG\") != \"\": log.Ctx(ctx).Info().Msgf(\"Creating cluster-external Provider client from KUBECONFIG %s\", os.Getenv(\"KUBECONFIG\")) client, err = newExternalClusterClientFromFile(os.Getenv(\"KUBECONFIG\")) default: log.Ctx(ctx).Info().Msgf(\"Creating cluster-external Provider client%s\", withEndpoint) client, err = newExternalClusterClient(p.Endpoint, p.CertAuthFilePath, p.Token) } if err != nil { return nil, err } client.labelSelector = p.LabelSelector return client, nil } 2.2. Resource Watching:\nThe provider employs the Kubernetes client to observe changes in pertinent resources. Informers are typically utilized to efficiently track these resources and receive notifications upon creation, update, or deletion.\npkg/provider/kubernetes/crd/kubernetes.go\n// Provide allows the k8s provider to provide configurations to traefik// using the given configuration channel. func (p *Provider) Provide(configurationChan chan\u003c- dynamic.Message, pool *safe.Pool) error { logger := log.With().Str(logs.ProviderName, providerName).Logger() ctxLog := logger.WithContext(context.Background()) k8sClient, err := p.newK8sClient(ctxLog) if err != nil { return err } if p.AllowCrossNamespace { logger.Warn().Msg(\"Cross-namespace reference between IngressRoutes and resources is enabled, please ensure that this is expected (see AllowCrossNamespace option)\") } if p.AllowExternalNameServices { logger.Warn().Msg(\"ExternalName service loading is enabled, please ensure that this is expected (see AllowExternalNameServices option)\") } pool.GoCtx(func(ctxPool context.Context) { operation := func() error { eventsChan, err := k8sClient.WatchAll(p.Namespaces, ctxPool.Done()) if err != nil { logger.Error().Err(err).Msg(\"Error watching kubernetes events\") timer := time.NewTimer(1 * time.Second) select { case \u003c-timer.C: return err case \u003c-ctxPool.Done(): return nil } } throttleDuration := time.Duration(p.ThrottleDuration) throttledChan := throttleEvents(ctxLog, throttleDuration, pool, eventsChan) if throttledChan != nil { eventsChan = throttledChan } for { select { case \u003c-ctxPool.Done(): return nil case event := \u003c-eventsChan: // Note that event is the *first* event that came in during this throttling interval -- if we're hitting our throttle, we may have dropped events. // This is fine, because we don't treat different event types differently. // But if we do in the future, we'll need to track more information about the dropped events. conf := p.loadConfigurationFromCRD(ctxLog, k8sClient) confHash, err := hashstructure.Hash(conf, nil) switch { case err != nil: logger.Error().Err(err).Msg(\"Unable to hash the configuration\") case p.lastConfiguration.Get() == confHash: logger.Debug().Msgf(\"Skipping Kubernetes event kind %T\", event) default: p.lastConfiguration.Set(confHash) configurationChan \u003c- dynamic.Message{ ProviderName: providerName, Configuration: conf, } } // If we're throttling, // we sleep here for the throttle duration to enforce that we don't refresh faster than our throttle. // time.Sleep returns immediately if p.ThrottleDuration is 0 (no throttle). time.Sleep(throttleDuration) } } } notify := func(err error, time time.Duration) { logger.Error().Err(err).Msgf(\"Provider error, retrying in %s\", time) } err := backoff.RetryNotify(safe.OperationWithRecover(operation), backoff.WithContext(job.NewBackOff(backoff.NewExponentialBackOff()), ctxPool), notify) if err != nil { logger.Error().Err(err).Msg(\"Cannot retrieve data\") } }) return nil } 2.3. Configuration Parsing:\nUpon receiving resource updates, the provider parses the data to extract configuration details. These configurations are then converted into Traefik-specific formats for routers, services, and middlewares.\npkg/provider/kubernetes/crd/kubernetes.go\nfunc (p *Provider) loadConfigurationFromCRD(ctx context.Context, client Client) *dynamic.Configuration { // ... conf := \u0026dynamic.Configuration{ // TODO: choose between mutating and returning tlsConfigs HTTP: p.loadIngressRouteConfiguration(ctx, client, tlsConfigs), TCP: p.loadIngressRouteTCPConfiguration(ctx, client, tlsConfigs), UDP: p.loadIngressRouteUDPConfiguration(ctx, client), TLS: \u0026dynamic.TLSConfiguration{ Options: buildTLSOptions(ctx, client), Stores: stores, }, } //... conf.HTTP.Middlewares[id] = \u0026dynamic.Middleware{ AddPrefix: middleware.Spec.AddPrefix, StripPrefix: middleware.Spec.StripPrefix, StripPrefixRegex: middleware.Spec.StripPrefixRegex, ReplacePath: middleware.Spec.ReplacePath, ReplacePathRegex: middleware.Spec.ReplacePathRegex, Chain: createChainMiddleware(ctxMid, middleware.Namespace, middleware.Spec.Chain), IPWhiteList: middleware.Spec.IPWhiteList, IPAllowList: middleware.Spec.IPAllowList, Headers: middleware.Spec.Headers, Errors: errorPage, RateLimit: rateLimit, RedirectRegex: middleware.Spec.RedirectRegex, RedirectScheme: middleware.Spec.RedirectScheme, BasicAuth: basicAuth, DigestAuth: digestAuth, ForwardAuth: forwardAuth, InFlightReq: middleware.Spec.InFlightReq, Buffering: middleware.Spec.Buffering, CircuitBreaker: circuitBreaker, Compress: middleware.Spec.Compress, PassTLSClientCert: middleware.Spec.PassTLSClientCert, Retry: retry, ContentType: middleware.Spec.ContentType, GrpcWeb: middleware.Spec.GrpcWeb, Plugin: plugin, } } //... cb := configBuilder{ client: client, allowCrossNamespace: p.AllowCrossNamespace, allowExternalNameServices: p.AllowExternalNameServices, allowEmptyServices: p.AllowEmptyServices, } for _, service := range client.GetTraefikServices() { err := cb.buildTraefikService(ctx, service, conf.HTTP.Services) if err != nil { log.Ctx(ctx).Error().Str(logs.ServiceName, service.Name).Err(err). Msg(\"Error while building TraefikService\") continue } } //... id := provider.Normalize(makeID(serversTransport.Namespace, serversTransport.Name)) conf.HTTP.ServersTransports[id] = \u0026dynamic.ServersTransport{ ServerName: serversTransport.Spec.ServerName, InsecureSkipVerify: serversTransport.Spec.InsecureSkipVerify, RootCAs: rootCAs, Certificates: certs, DisableHTTP2: serversTransport.Spec.DisableHTTP2, MaxIdleConnsPerHost: serversTransport.Spec.MaxIdleConnsPerHost, ForwardingTimeouts: forwardingTimeout, PeerCertURI: serversTransport.Spec.PeerCertURI, Spiffe: serversTransport.Spec.Spiffe, } } // ... for _, serversTransportTCP := range client.GetServersTransportTCPs() { var tcpServerTransport dynamic.TCPServersTransport tcpServerTransport.SetDefaults() if serversTransportTCP.Spec.DialTimeout != nil { // ... } if serversTransportTCP.Spec.DialKeepAlive != nil { // ... } if serversTransportTCP.Spec.TerminationDelay != nil { // ... } if serversTransportTCP.Spec.TLS != nil { var rootCAs []types.FileOrContent for _, secret := range serversTransportTCP.Spec.TLS.RootCAsSecrets { caSecret, err := loadCASecret(serversTransportTCP.Namespace, secret, client) if err != nil { logger.Error(). Err(err). Str(\"rootCAs\", secret). Msg(\"Error while loading rootCAs\") continue } rootCAs = append(rootCAs, types.FileOrContent(caSecret)) } var certs tls.Certificates for _, secret := range serversTransportTCP.Spec.TLS.CertificatesSecrets { tlsCert, tlsKey, err := loadAuthTLSSecret(serversTransportTCP.Namespace, secret, client) if err != nil { logger.Error(). Err(err). Str(\"certificates\", secret). Msg(\"Error while loading certificates\") continue } certs = append(certs, tls.Certificate{ CertFile: types.FileOrContent(tlsCert), KeyFile: types.FileOrContent(tlsKey), }) } tcpServerTransport.TLS = \u0026dynamic.TLSClientConfig{ ServerName: serversTransportTCP.Spec.TLS.ServerName, InsecureSkipVerify: serversTransportTCP.Spec.TLS.InsecureSkipVerify, RootCAs: rootCAs, Certificates: certs, PeerCertURI: serversTransportTCP.Spec.TLS.PeerCertURI, } tcpServerTransport.TLS.Spiffe = serversTransportTCP.Spec.TLS.Spiffe } id := provider.Normalize(makeID(serversTransportTCP.Namespace, serversTransportTCP.Name)) conf.TCP.ServersTransports[id] = \u0026tcpServerTransport } } 2.4. Configuration Updates:\nProviders transmit the Traefik-ready configurations to the watcher through configurationChan. The watcher then consolidates these updates and forwards them to the listener for application.\nThis process ensures that Traefik dynamically updates its routing rules and configurations to align with the evolving state of the Kubernetes cluster.\n3. Switcher:\nThe essence of the switcher is the combination of sync.Map + interface{}, the purpose of which is to obtain and dynamically update the handler in a thread-safe manner.\npkg/safe/safe.go\n// Safe encapsulates a thread-safe value. type Safe struct { value interface{} lock sync.RWMutex } pkg/server/server_entrypoint_tcp.go\nfunc createHTTPServer(ctx context.Context, ln net.Listener, configuration *static.EntryPoint, withH2c bool, reqDecorator *requestdecorator.RequestDecorator) (*httpServer, error) { if configuration.HTTP2.MaxConcurrentStreams \u003c 0 { return nil, errors.New(\"max concurrent streams value must be greater than or equal to zero\") } httpSwitcher := middlewares.NewHandlerSwitcher(router.BuildDefaultHTTPRouter()) next, err := alice.New(requestdecorator.WrapHandler(reqDecorator)).Then(httpSwitcher) if err != nil { return nil, err } pkg/middlewares/handler_switcher.go\n// NewHandlerSwitcher builds a new instance of HTTPHandlerSwitcher. func NewHandlerSwitcher(newHandler http.Handler) (hs *HTTPHandlerSwitcher) { return \u0026HTTPHandlerSwitcher{ handler: safe.New(newHandler), } } func (h *HTTPHandlerSwitcher) ServeHTTP(rw http.ResponseWriter, req *http.Request) { handlerBackup := h.handler.Get().(http.Handler) handlerBackup.ServeHTTP(rw, req) } // GetHandler returns the current http.ServeMux. func (h *HTTPHandlerSwitcher) GetHandler() (newHandler http.Handler) { handler := h.handler.Get().(http.Handler) return handler } // UpdateHandler safely updates the current http.ServeMux with a new one.func (h *HTTPHandlerSwitcher) UpdateHandler(newHandler http.Handler) { h.handler.Set(newHandler) } Health Checks: Ensuring Availability Traefik conducts health checks on both itself and backend services to guarantee that traffic is routed only to operational instances.\nSelf Health Check Traefik implements self-health checks through the /ping endpoint. This endpoint can be invoked by external systems to ascertain Traefik’s health status.\n// Do try to do a healthcheck.func Do(staticConfiguration static.Configuration) (*http.Response, error) { if staticConfiguration.Ping == nil { return nil, errors.New(\"please enable `ping` to use health check\") } ep := staticConfiguration.Ping.EntryPoint if ep == \"\" { ep = \"traefik\" } pingEntryPoint, ok := staticConfiguration.EntryPoints[ep] if !ok { return nil, fmt.Errorf(\"ping: missing %s entry point\", ep) } client := \u0026http.Client{Timeout: 5 * time.Second} protocol := \"http\" path := \"/\" return client.Head(protocol + \"://\" + pingEntryPoint.GetAddress() + path + \"ping\") } This endpoint returns a 200 OK status when Traefik is operational. A failed health check results in a non-200 status code, signaling an issue.\nBackend Service Health Checks Traefik supports health checks for backend services across HTTP, HTTPS, and gRPC protocols. Configurable health checks enable the assessment of backend server availability.\nThe following is an abridged version of how Traefik conducts backend service health checks:\nConfiguration: Health check specifics are set in the service configuration, detailing parameters like the health check path, interval, and timeout. Health Checker: A ServiceHealthChecker is instantiated for each service with enabled health checks. Periodic Checks: The health checker periodically sends requests to backend servers based on the interval setting. Status Updates: The health checker updates each server’s status according to the health check response. Load Balancer Updates: The loader balancer is notified of any status changes, which it considers when distributing requests. Here’s a snippet of the Go code for the ServiceHealthChecker: pkg/healthcheck/healthcheck.go\nfunc NewServiceHealthChecker(ctx context.Context, metrics metricsHealthCheck, config *dynamic.ServerHealthCheck, service StatusSetter, info *runtime.ServiceInfo, transport http.RoundTripper, targets map[string]*url.URL) *ServiceHealthChecker { logger := log.Ctx(ctx) interval := time.Duration(config.Interval) if interval \u003c= 0 { logger.Error().Msg(\"Health check interval smaller than zero\") interval = time.Duration(dynamic.DefaultHealthCheckInterval) } timeout := time.Duration(config.Timeout) if timeout \u003c= 0 { logger.Error().Msg(\"Health check timeout smaller than zero\") timeout = time.Duration(dynamic.DefaultHealthCheckTimeout) } client := \u0026http.Client{ Transport: transport, } if config.FollowRedirects != nil \u0026\u0026 !*config.FollowRedirects { client.CheckRedirect = func(req *http.Request, via []*http.Request) error { return http.ErrUseLastResponse } } return \u0026ServiceHealthChecker{ balancer: service, info: info, config: config, interval: interval, timeout: timeout, targets: targets, client: client, metrics: metrics, } } func (shc *ServiceHealthChecker) Launch(ctx context.Context) { ticker := time.NewTicker(shc.interval) defer ticker.Stop() for { select { case \u003c-ctx.Done(): return case \u003c-ticker.C: for proxyName, target := range shc.targets { select { case \u003c-ctx.Done(): return default: } up := true serverUpMetricValue := float64(1) if err := shc.executeHealthCheck(ctx, shc.config, target); err != nil { // The context is canceled when the dynamic configuration is refreshed. if errors.Is(err, context.Canceled) { return } log.Ctx(ctx).Warn(). Str(\"targetURL\", target.String()). Err(err). Msg(\"Health check failed.\") up = false serverUpMetricValue = float64(0) } shc.balancer.SetStatus(ctx, proxyName, up) statusStr := runtime.StatusDown if up { statusStr = runtime.StatusUp } shc.info.UpdateServerStatus(target.String(), statusStr) shc.metrics.ServiceServerUpGauge(). With(\"service\", proxyName, \"url\", target.String()). Set(serverUpMetricValue) } } } } func (shc *ServiceHealthChecker) executeHealthCheck(ctx context.Context, config *dynamic.ServerHealthCheck, target *url.URL) error { ctx, cancel := context.WithDeadline(ctx, time.Now().Add(shc.timeout)) defer cancel() if config.Mode == modeGRPC { return shc.checkHealthGRPC(ctx, target) } return shc.checkHealthHTTP(ctx, target) } // checkHealthHTTP returns an error with a meaningful description if the health check failed.// Dedicated to HTTP servers. func (shc *ServiceHealthChecker) checkHealthHTTP(ctx context.Context, target *url.URL) error { req, err := shc.newRequest(ctx, target) if err != nil { return fmt.Errorf(\"create HTTP request: %w\", err) } resp, err := shc.client.Do(req) if err != nil { return fmt.Errorf(\"HTTP request failed: %w\", err) } defer resp.Body.Close() if shc.config.Status == 0 \u0026\u0026 (resp.StatusCode \u003c http.StatusOK || resp.StatusCode \u003e= http.StatusBadRequest) { return fmt.Errorf(\"received error status code: %v\", resp.StatusCode) } if shc.config.Status != 0 \u0026\u0026 shc.config.Status != resp.StatusCode { return fmt.Errorf(\"received error status code: %v expected status code: %v\", resp.StatusCode, shc.config.Status) } return nil } This code illustrates the health checker dispatching a health check request and updating the server status based on the response. The load balancer then uses this information to direct traffic only to responsive servers.\nMiddleware: Enhancing the Routing Process Traefik’s middleware system allows for the injection of additional functionality into the request/response lifecycle. Middlewares can be linked to routers or services to perform tasks such as authentication, rate limiting, and request transformation.\nTraefik provides an extensive range of built-in middlewares, and custom middlewares can be integrated via plugins.\nMiddleware Processing Pipeline The following outlines how Traefik processes middlewares:\nConfiguration: Middlewares are defined in the dynamic configuration and linked to routers or services. Middleware Chain: A chain of middlewares is constructed based on the configuration, with the order determining their execution sequence. Request Processing: Incoming requests traverse the middleware chain before reaching the backend service, allowing each middleware to alter the request or generate a response. Response Processing: After the backend service responds, the response is pushed back through the middleware chain in reverse order, permitting modification before reaching the client. Source Code Analysis: Middleware Builder The middleware.Builder is responsible for constructing the middleware chain from the configuration. It provides a BuildChain function that accepts a context and a list of middleware names, returning an alice.Chain object.\nHere’s an abridged version of the BuildChain function: pkg/server/middleware/middlewares.go\nfunc (b *Builder) BuildChain(ctx context.Context, middlewares []string) *alice.Chain { chain := alice.New() for _, name := range middlewares { middlewareName := provider.GetQualifiedName(ctx, name) chain = chain.Append(func(next http.Handler) (http.Handler, error) { constructorContext := provider.AddInContext(ctx, middlewareName) if midInf, ok := b.configs[middlewareName]; !ok || midInf.Middleware == nil { return nil, fmt.Errorf(\"middleware %q does not exist\", middlewareName) } var err error if constructorContext, err = checkRecursion(constructorContext, middlewareName); err != nil { b.configs[middlewareName].AddError(err, true) return nil, err } constructor, err := b.buildConstructor(constructorContext, middlewareName) if err != nil { b.configs[middlewareName].AddError(err, true) return nil, err } handler, err := constructor(next) if err != nil { b.configs[middlewareName].AddError(err, true) return nil, err } return handler, nil }) } return \u0026chain } func checkRecursion(ctx context.Context, middlewareName string) (context.Context, error) { currentStack, ok := ctx.Value(middlewareStackKey).([]string) if !ok { currentStack = []string{} } if inSlice(middlewareName, currentStack) { return ctx, fmt.Errorf(\"could not instantiate middleware %s: recursion detected in %s\", middlewareName, strings.Join(append(currentStack, middlewareName), \"-\u003e\")) } return context.WithValue(ctx, middlewareStackKey, append(currentStack, middlewareName)), nil } // it is the responsibility of the caller to make sure that b.configs[middlewareName].Middleware exists. func (b *Builder) buildConstructor(ctx context.Context, middlewareName string) (alice.Constructor, error) { config := b.configs[middlewareName] if config == nil || config.Middleware == nil { return nil, fmt.Errorf(\"invalid middleware %q configuration\", middlewareName) } var middleware alice.Constructor badConf := errors.New(\"cannot create middleware: multi-types middleware not supported, consider declaring two different pieces of middleware instead\") ... // Chain if config.Chain != nil { if middleware != nil { return nil, badConf } var qualifiedNames []string for _, name := range config.Chain.Middlewares { qualifiedNames = append(qualifiedNames, provider.GetQualifiedName(ctx, name)) } config.Chain.Middlewares = qualifiedNames middleware = func(next http.Handler) (http.Handler, error) { return chain.New(ctx, next, *config.Chain, b, middlewareName) } } ... if middleware == nil { return nil, fmt.Errorf(\"invalid middleware %q configuration: invalid middleware type or middleware does not exist\", middlewareName) } // The tracing middleware is a NOOP if tracing is not setup on the middleware chain. // Hence, regarding internal resources' observability deactivation, // this would not enable tracing. return tracing.WrapMiddleware(ctx, middleware), nil } This function iterates through middleware names to build a chain of constructors. Each constructor is tasked with creating a middleware instance and integrating it with the next handler in the chain.\nThe buildConstructor function creates the constructor for a specific middleware based on its configuration, applying reflection to identify the middleware type and instantiate the relevant function.\nThis methodology enables Traefik to support a diverse array of middlewares with varying configurations, while promoting a well-organized and modular codebase.\nConclusion Traefik’s architecture and source code exemplify a systematic and modular approach to managing static and dynamic configurations, provider integration, and health checks. Understanding these core principles and code elements empowers users to effectively harness Traefik for orchestrating complex deployments.\n","wordCount":"3206","inLanguage":"en","datePublished":"2024-03-09T14:54:00+08:00","dateModified":"2024-03-09T14:54:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://zhoukuncheng.github.io/posts/traefik-architecture-and-source-code-analysis/"},"publisher":{"@type":"Organization","name":"zhoukuncheng's Personal Blog","logo":{"@type":"ImageObject","url":"https://zhoukuncheng.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zhoukuncheng.github.io/ accesskey=h title="zhoukuncheng's Personal Blog (Alt + H)">zhoukuncheng's Personal Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://zhoukuncheng.github.io/ title=Home><span>Home</span></a></li><li><a href=https://zhoukuncheng.github.io/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://zhoukuncheng.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zhoukuncheng.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://zhoukuncheng.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Traefik Architecture and Source Code Analysis: A Deep Dive</h1><div class=post-meta><span title='2024-03-09 14:54:00 +0800 +0800'>March 9, 2024</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#traefik-architecture-a-high-level-overview aria-label="Traefik Architecture: A High-Level Overview">Traefik Architecture: A High-Level Overview</a></li><li><a href=#source-code-analysis-key-components aria-label="Source Code Analysis: Key Components">Source Code Analysis: Key Components</a></li><li><a href=#health-checks-ensuring-availability aria-label="Health Checks: Ensuring Availability">Health Checks: Ensuring Availability</a><ul><li><a href=#self-health-check aria-label="Self Health Check">Self Health Check</a></li><li><a href=#backend-service-health-checks aria-label="Backend Service Health Checks">Backend Service Health Checks</a></li></ul></li><li><a href=#middleware-enhancing-the-routing-process aria-label="Middleware: Enhancing the Routing Process">Middleware: Enhancing the Routing Process</a><ul><li><a href=#middleware-processing-pipeline aria-label="Middleware Processing Pipeline">Middleware Processing Pipeline</a></li><li><a href=#source-code-analysis-middleware-builder aria-label="Source Code Analysis: Middleware Builder">Source Code Analysis: Middleware Builder</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p><img loading=lazy src=https://doc.traefik.io/traefik/assets/img/traefik-architecture.png alt="Traefik Architecture Diagram"></p><p>Traefik is a widely adopted open-source HTTP reverse proxy and load balancer that simplifies the routing and load balancing of requests for modern web applications. It boasts dynamic configuration capabilities and supports a multitude of providers, positioning itself as a versatile solution for orchestrating complex deployment scenarios. In this blog post, we will delve into the architecture of Traefik and dissect the key components of its source code to furnish a more nuanced understanding of its operational mechanics.</p><h3 id=traefik-architecture-a-high-level-overview>Traefik Architecture: A High-Level Overview<a hidden class=anchor aria-hidden=true href=#traefik-architecture-a-high-level-overview>#</a></h3><p>At its core, Traefik&rsquo;s architecture is composed of several integral components that collaborate to facilitate dynamic routing and load balancing:</p><ul><li><p><strong>Static Configuration:</strong> These are foundational settings for Traefik, encompassing entry points, providers, and API access configurations. They can be specified via file, command-line arguments, or environment variables.</p></li><li><p><strong>Dynamic Configuration:</strong> This pertains to the routing rules, services, and middlewares that are adaptable based on the state of the infrastructure. Traefik&rsquo;s compatibility with a myriad of providers, such as Docker, Kubernetes, Consul Catalog, among others, underscores its dynamism.</p></li><li><p><strong>Providers:</strong> Acting as the bridge between Traefik and service discovery mechanisms, providers are tasked with sourcing and conveying dynamic configuration to Traefik. Each provider is tailored to integrate with different technologies like Docker, Kubernetes, and Consul.</p></li><li><p><strong>Entry Points:</strong> These designate the network interfaces (ports and protocols) where Traefik listens for inbound traffic.</p></li><li><p><strong>Routers:</strong> Routers establish criteria for matching incoming requests by various parameters such as hostnames, paths, and headers. They are responsible for directing requests to the appropriate service.</p></li><li><p><strong>Services:</strong> Services define the mechanisms through which Traefik communicates with backend systems that process the requests. These can be fine-tuned with distinct load balancing strategies and health checks.</p></li><li><p><strong>Middlewares:</strong> As modular entities, middlewares can be attached to routers or services, enabling a range of functions including authentication, rate limiting, and request modification.</p></li><li><p><strong>Plugins:</strong> Traefik can be extended with plugins, which augment its functionality. The plugin system empowers developers to contribute custom plugins.</p></li></ul><p>The orchestration of these components is as follows:</p><ol><li>Traefik ingests the static configuration and begins monitoring the specified entry points.</li><li>Providers perpetually scan the infrastructure for configuration changes, relaying them to Traefik via a dynamic configuration channel.</li><li>Traefik processes the dynamic configuration, updating its internal constructs—routers, services, and middlewares—to reflect these changes.</li><li>As requests come in, Traefik matches them against router rules and channels them to the designated service.</li><li>Services apply their load balancing logic to distribute the request to a backend server.</li><li>Middlewares may be invoked at various stages in the request/response lifecycle to perform their respective duties.</li></ol><p>This dynamic architecture enables Traefik to nimbly adjust to alterations within the infrastructure, automating the routing configuration in alignment with the deployed services.</p><h3 id=source-code-analysis-key-components>Source Code Analysis: Key Components<a hidden class=anchor aria-hidden=true href=#source-code-analysis-key-components>#</a></h3><p>Now, let&rsquo;s examine some of the pivotal components within Traefik&rsquo;s source code:</p><p><img loading=lazy src=https://xiaorui.cc/wp-content/uploads/2022/11/Jietu20221123-124659.jpg alt></p><p><strong>1. Watcher and Listener:</strong></p><p>The watcher and listener collaborate to detect and enact dynamic configuration changes. The watcher is in charge of incessantly surveying configuration sources and propelling updates to the listener. Subsequently, the listener validates these updates and integrates them with Traefik&rsquo;s internal state.</p><p><strong>Watcher:</strong>
<code>pkg/server/configurationwatcher.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewConfigurationWatcher creates a new ConfigurationWatcher.  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewConfigurationWatcher</span><span class=p>(</span>  
</span></span><span class=line><span class=cl>   <span class=nx>routinesPool</span> <span class=o>*</span><span class=nx>safe</span><span class=p>.</span><span class=nx>Pool</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   <span class=nx>pvd</span> <span class=nx>provider</span><span class=p>.</span><span class=nx>Provider</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   <span class=nx>defaultEntryPoints</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   <span class=nx>requiredProvider</span> <span class=kt>string</span><span class=p>,</span>  
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span><span class=nx>ConfigurationWatcher</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=o>&amp;</span><span class=nx>ConfigurationWatcher</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>providerAggregator</span><span class=p>:</span>  <span class=nx>pvd</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>allProvidersConfigs</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span> <span class=mi>100</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>      <span class=nx>newConfigs</span><span class=p>:</span>          <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configurations</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>      <span class=nx>routinesPool</span><span class=p>:</span>        <span class=nx>routinesPool</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>defaultEntryPoints</span><span class=p>:</span>  <span class=nx>defaultEntryPoints</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>requiredProvider</span><span class=p>:</span>    <span class=nx>requiredProvider</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// Start the configuration watcher.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=p>)</span> <span class=nf>Start</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>c</span><span class=p>.</span><span class=nx>routinesPool</span><span class=p>.</span><span class=nf>GoCtx</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>receiveConfigurations</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=nx>c</span><span class=p>.</span><span class=nx>routinesPool</span><span class=p>.</span><span class=nf>GoCtx</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>applyConfigurations</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=nx>c</span><span class=p>.</span><span class=nf>startProviderAggregator</span><span class=p>()</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// Stop the configuration watcher.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=p>)</span> <span class=nf>Stop</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nb>close</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>allProvidersConfigs</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=nb>close</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>newConfigs</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// AddListener adds a new listener function used when new configuration is provided.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=p>)</span> <span class=nf>AddListener</span><span class=p>(</span><span class=nx>listener</span> <span class=kd>func</span><span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>))</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>configurationListeners</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>c</span><span class=p>.</span><span class=nx>configurationListeners</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kd>func</span><span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=nx>c</span><span class=p>.</span><span class=nx>configurationListeners</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>configurationListeners</span><span class=p>,</span> <span class=nx>listener</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=p>)</span> <span class=nf>startProviderAggregator</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Starting provider aggregator %T&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>providerAggregator</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>safe</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>providerAggregator</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>allProvidersConfigs</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>routinesPool</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Error starting provider aggregator %T&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>providerAggregator</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>})</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Listener:</strong>
<code>cmd/traefik/traefik.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Server Transports  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>watcher</span><span class=p>.</span><span class=nf>AddListener</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>conf</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>roundTripperManager</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>HTTP</span><span class=p>.</span><span class=nx>ServersTransports</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=nx>dialerManager</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>TCP</span><span class=p>.</span><span class=nx>ServersTransports</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p><code>pkg/server/service/roundtripper.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// RoundTripperManager handles roundtripper for the reverse proxy.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>RoundTripperManager</span> <span class=kd>struct</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>rtLock</span>        <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>  
</span></span><span class=line><span class=cl>   <span class=nx>roundTrippers</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>http</span><span class=p>.</span><span class=nx>RoundTripper</span>  
</span></span><span class=line><span class=cl>   <span class=nx>configs</span>       <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServersTransport</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>spiffeX509Source</span> <span class=nx>SpiffeX509Source</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// Update updates the roundtrippers configurations.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RoundTripperManager</span><span class=p>)</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>newConfigs</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServersTransport</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>r</span><span class=p>.</span><span class=nx>rtLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>   <span class=k>defer</span> <span class=nx>r</span><span class=p>.</span><span class=nx>rtLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>configName</span><span class=p>,</span> <span class=nx>config</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span><span class=p>.</span><span class=nx>configs</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>newConfig</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>newConfigs</span><span class=p>[</span><span class=nx>configName</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nb>delete</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>configs</span><span class=p>,</span> <span class=nx>configName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=nb>delete</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>,</span> <span class=nx>configName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=k>continue</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>DeepEqual</span><span class=p>(</span><span class=nx>newConfig</span><span class=p>,</span> <span class=nx>config</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>continue</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>  
</span></span><span class=line><span class=cl>      <span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>[</span><span class=nx>configName</span><span class=p>],</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>createRoundTripper</span><span class=p>(</span><span class=nx>newConfig</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Could not configure HTTP Transport %s, fallback on default transport&#34;</span><span class=p>,</span> <span class=nx>configName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>[</span><span class=nx>configName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>DefaultTransport</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>newConfigName</span><span class=p>,</span> <span class=nx>newConfig</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>newConfigs</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>newConfigName</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>continue</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>  
</span></span><span class=line><span class=cl>      <span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>[</span><span class=nx>newConfigName</span><span class=p>],</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>createRoundTripper</span><span class=p>(</span><span class=nx>newConfig</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Could not configure HTTP Transport %s, fallback on default transport&#34;</span><span class=p>,</span> <span class=nx>newConfigName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>[</span><span class=nx>newConfigName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>DefaultTransport</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>r</span><span class=p>.</span><span class=nx>configs</span> <span class=p>=</span> <span class=nx>newConfigs</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>2. Provider:</strong></p><p>Providers are pivotal in Traefik&rsquo;s architecture, interfacing with specific technologies to unearth and deliver configuration updates. The <code>Provide</code> function lies at the heart of the provider&rsquo;s role, managing connection, discovery, and update processes.</p><p><strong>Kubernetes Provider: Configuration Discovery</strong></p><p>The Kubernetes provider within Traefik extracts configuration details from the Kubernetes API server, monitoring changes across Kubernetes resources like Ingress, IngressRoute, Service, and Middleware objects.</p><p><strong>2.1. Kubernetes Client Initialization:</strong></p><p>The provider initializes a client to connect with the Kubernetes API, utilizing this client to engage with the API and observe resource changes.</p><p><code>pkg/provider/kubernetes/crd/kubernetes.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>Provider</span><span class=p>)</span> <span class=nf>newK8sClient</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>clientWrapper</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>labels</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid label selector: %q&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;label selector is: %q&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>withEndpoint</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Endpoint</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>withEndpoint</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34; with endpoint %s&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>client</span> <span class=o>*</span><span class=nx>clientWrapper</span>  
</span></span><span class=line><span class=cl>   <span class=k>switch</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBERNETES_SERVICE_HOST&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBERNETES_SERVICE_PORT&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>      <span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Creating in-cluster Provider client%s&#34;</span><span class=p>,</span> <span class=nx>withEndpoint</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>newInClusterClient</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBECONFIG&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>      <span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Creating cluster-external Provider client from KUBECONFIG %s&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBECONFIG&#34;</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>newExternalClusterClientFromFile</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBECONFIG&#34;</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>   <span class=k>default</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>      <span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Creating cluster-external Provider client%s&#34;</span><span class=p>,</span> <span class=nx>withEndpoint</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>newExternalClusterClient</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>CertAuthFilePath</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Token</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>client</span><span class=p>.</span><span class=nx>labelSelector</span> <span class=p>=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>LabelSelector</span>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>client</span><span class=p>,</span> <span class=kc>nil</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>2.2. Resource Watching:</strong></p><p>The provider employs the Kubernetes client to observe changes in pertinent resources. Informers are typically utilized to efficiently track these resources and receive notifications upon creation, update, or deletion.</p><p><code>pkg/provider/kubernetes/crd/kubernetes.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Provide allows the k8s provider to provide configurations to traefik// using the given configuration channel.  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>Provider</span><span class=p>)</span> <span class=nf>Provide</span><span class=p>(</span><span class=nx>configurationChan</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span> <span class=nx>pool</span> <span class=o>*</span><span class=nx>safe</span><span class=p>.</span><span class=nx>Pool</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>With</span><span class=p>().</span><span class=nf>Str</span><span class=p>(</span><span class=nx>logs</span><span class=p>.</span><span class=nx>ProviderName</span><span class=p>,</span> <span class=nx>providerName</span><span class=p>).</span><span class=nf>Logger</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>   <span class=nx>ctxLog</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>k8sClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>newK8sClient</span><span class=p>(</span><span class=nx>ctxLog</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>err</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>AllowCrossNamespace</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nf>Warn</span><span class=p>().</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Cross-namespace reference between IngressRoutes and resources is enabled, please ensure that this is expected (see AllowCrossNamespace option)&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>AllowExternalNameServices</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nf>Warn</span><span class=p>().</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;ExternalName service loading is enabled, please ensure that this is expected (see AllowExternalNameServices option)&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>pool</span><span class=p>.</span><span class=nf>GoCtx</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>ctxPool</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>operation</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>eventsChan</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>k8sClient</span><span class=p>.</span><span class=nf>WatchAll</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Namespaces</span><span class=p>,</span> <span class=nx>ctxPool</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>  
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Error watching kubernetes events&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=nx>timer</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>timer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>               <span class=k>return</span> <span class=nx>err</span>  
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctxPool</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>  
</span></span><span class=line><span class=cl>               <span class=k>return</span> <span class=kc>nil</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=nx>throttleDuration</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>ThrottleDuration</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=nx>throttledChan</span> <span class=o>:=</span> <span class=nf>throttleEvents</span><span class=p>(</span><span class=nx>ctxLog</span><span class=p>,</span> <span class=nx>throttleDuration</span><span class=p>,</span> <span class=nx>pool</span><span class=p>,</span> <span class=nx>eventsChan</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>throttledChan</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=nx>eventsChan</span> <span class=p>=</span> <span class=nx>throttledChan</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctxPool</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>  
</span></span><span class=line><span class=cl>               <span class=k>return</span> <span class=kc>nil</span>  
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>event</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>eventsChan</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>               <span class=c1>// Note that event is the *first* event that came in during this throttling interval -- if we&#39;re hitting our throttle, we may have dropped events.  
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=c1>// This is fine, because we don&#39;t treat different event types differently.               
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=c1>// But if we do in the future, we&#39;ll need to track more information about the dropped events.               
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=nx>conf</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>loadConfigurationFromCRD</span><span class=p>(</span><span class=nx>ctxLog</span><span class=p>,</span> <span class=nx>k8sClient</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>               <span class=nx>confHash</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>hashstructure</span><span class=p>.</span><span class=nf>Hash</span><span class=p>(</span><span class=nx>conf</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>               <span class=k>switch</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>               <span class=k>case</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>                  <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Unable to hash the configuration&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>               <span class=k>case</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lastConfiguration</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span> <span class=o>==</span> <span class=nx>confHash</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>                  <span class=nx>logger</span><span class=p>.</span><span class=nf>Debug</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Skipping Kubernetes event kind %T&#34;</span><span class=p>,</span> <span class=nx>event</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>               <span class=k>default</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>                  <span class=nx>p</span><span class=p>.</span><span class=nx>lastConfiguration</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>confHash</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>                  <span class=nx>configurationChan</span> <span class=o>&lt;-</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>Message</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>                     <span class=nx>ProviderName</span><span class=p>:</span>  <span class=nx>providerName</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>                     <span class=nx>Configuration</span><span class=p>:</span> <span class=nx>conf</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>                  <span class=p>}</span>  
</span></span><span class=line><span class=cl>               <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>               <span class=c1>// If we&#39;re throttling,  
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=c1>// we sleep here for the throttle duration to enforce that we don&#39;t refresh faster than our throttle.               
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=c1>// time.Sleep returns immediately if p.ThrottleDuration is 0 (no throttle).               
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>throttleDuration</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=nx>notify</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>,</span> <span class=nx>time</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Provider error, retrying in %s&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>      <span class=nx>err</span> <span class=o>:=</span> <span class=nx>backoff</span><span class=p>.</span><span class=nf>RetryNotify</span><span class=p>(</span><span class=nx>safe</span><span class=p>.</span><span class=nf>OperationWithRecover</span><span class=p>(</span><span class=nx>operation</span><span class=p>),</span> <span class=nx>backoff</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>job</span><span class=p>.</span><span class=nf>NewBackOff</span><span class=p>(</span><span class=nx>backoff</span><span class=p>.</span><span class=nf>NewExponentialBackOff</span><span class=p>()),</span> <span class=nx>ctxPool</span><span class=p>),</span> <span class=nx>notify</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Cannot retrieve data&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>})</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>nil</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>2.3. Configuration Parsing:</strong></p><p>Upon receiving resource updates, the provider parses the data to extract configuration details. These configurations are then converted into Traefik-specific formats for routers, services, and middlewares.</p><p><code>pkg/provider/kubernetes/crd/kubernetes.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>Provider</span><span class=p>)</span> <span class=nf>loadConfigurationFromCRD</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>client</span> <span class=nx>Client</span><span class=p>)</span> <span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>conf</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=c1>// TODO: choose between mutating and returning tlsConfigs  
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>HTTP</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nf>loadIngressRouteConfiguration</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>client</span><span class=p>,</span> <span class=nx>tlsConfigs</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>      <span class=nx>TCP</span><span class=p>:</span>  <span class=nx>p</span><span class=p>.</span><span class=nf>loadIngressRouteTCPConfiguration</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>client</span><span class=p>,</span> <span class=nx>tlsConfigs</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>      <span class=nx>UDP</span><span class=p>:</span>  <span class=nx>p</span><span class=p>.</span><span class=nf>loadIngressRouteUDPConfiguration</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>client</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>      <span class=nx>TLS</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>TLSConfiguration</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Options</span><span class=p>:</span> <span class=nf>buildTLSOptions</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>client</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Stores</span><span class=p>:</span>  <span class=nx>stores</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=p>},</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>conf</span><span class=p>.</span><span class=nx>HTTP</span><span class=p>.</span><span class=nx>Middlewares</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Middleware</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>AddPrefix</span><span class=p>:</span>         <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>AddPrefix</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>StripPrefix</span><span class=p>:</span>       <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>StripPrefix</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>StripPrefixRegex</span><span class=p>:</span>  <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>StripPrefixRegex</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>ReplacePath</span><span class=p>:</span>       <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ReplacePath</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>ReplacePathRegex</span><span class=p>:</span>  <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ReplacePathRegex</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Chain</span><span class=p>:</span>             <span class=nf>createChainMiddleware</span><span class=p>(</span><span class=nx>ctxMid</span><span class=p>,</span> <span class=nx>middleware</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Chain</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>         <span class=nx>IPWhiteList</span><span class=p>:</span>       <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>IPWhiteList</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>IPAllowList</span><span class=p>:</span>       <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>IPAllowList</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Headers</span><span class=p>:</span>           <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Headers</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Errors</span><span class=p>:</span>            <span class=nx>errorPage</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>RateLimit</span><span class=p>:</span>         <span class=nx>rateLimit</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>RedirectRegex</span><span class=p>:</span>     <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>RedirectRegex</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>RedirectScheme</span><span class=p>:</span>    <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>RedirectScheme</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>BasicAuth</span><span class=p>:</span>         <span class=nx>basicAuth</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>DigestAuth</span><span class=p>:</span>        <span class=nx>digestAuth</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>ForwardAuth</span><span class=p>:</span>       <span class=nx>forwardAuth</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>InFlightReq</span><span class=p>:</span>       <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>InFlightReq</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Buffering</span><span class=p>:</span>         <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Buffering</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>CircuitBreaker</span><span class=p>:</span>    <span class=nx>circuitBreaker</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Compress</span><span class=p>:</span>          <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Compress</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>PassTLSClientCert</span><span class=p>:</span> <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>PassTLSClientCert</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Retry</span><span class=p>:</span>             <span class=nx>retry</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>ContentType</span><span class=p>:</span>       <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ContentType</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>GrpcWeb</span><span class=p>:</span>           <span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>GrpcWeb</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Plugin</span><span class=p>:</span>            <span class=nx>plugin</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>cb</span> <span class=o>:=</span> <span class=nx>configBuilder</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>:</span>                    <span class=nx>client</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>allowCrossNamespace</span><span class=p>:</span>       <span class=nx>p</span><span class=p>.</span><span class=nx>AllowCrossNamespace</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>allowExternalNameServices</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>AllowExternalNameServices</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>allowEmptyServices</span><span class=p>:</span>        <span class=nx>p</span><span class=p>.</span><span class=nx>AllowEmptyServices</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>service</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>client</span><span class=p>.</span><span class=nf>GetTraefikServices</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cb</span><span class=p>.</span><span class=nf>buildTraefikService</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>service</span><span class=p>,</span> <span class=nx>conf</span><span class=p>.</span><span class=nx>HTTP</span><span class=p>.</span><span class=nx>Services</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Str</span><span class=p>(</span><span class=nx>logs</span><span class=p>.</span><span class=nx>ServiceName</span><span class=p>,</span> <span class=nx>service</span><span class=p>.</span><span class=nx>Name</span><span class=p>).</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span>  
</span></span><span class=line><span class=cl>            <span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Error while building TraefikService&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=k>continue</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>id</span> <span class=o>:=</span> <span class=nx>provider</span><span class=p>.</span><span class=nf>Normalize</span><span class=p>(</span><span class=nf>makeID</span><span class=p>(</span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Name</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>      <span class=nx>conf</span><span class=p>.</span><span class=nx>HTTP</span><span class=p>.</span><span class=nx>ServersTransports</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServersTransport</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>ServerName</span><span class=p>:</span>          <span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ServerName</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>InsecureSkipVerify</span><span class=p>:</span>  <span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>InsecureSkipVerify</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>RootCAs</span><span class=p>:</span>             <span class=nx>rootCAs</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Certificates</span><span class=p>:</span>        <span class=nx>certs</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>DisableHTTP2</span><span class=p>:</span>        <span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>DisableHTTP2</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>MaxIdleConnsPerHost</span><span class=p>:</span> <span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxIdleConnsPerHost</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>ForwardingTimeouts</span><span class=p>:</span>  <span class=nx>forwardingTimeout</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>PeerCertURI</span><span class=p>:</span>         <span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>PeerCertURI</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=nx>Spiffe</span><span class=p>:</span>              <span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Spiffe</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>serversTransportTCP</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>client</span><span class=p>.</span><span class=nf>GetServersTransportTCPs</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>tcpServerTransport</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nx>TCPServersTransport</span>  
</span></span><span class=line><span class=cl>      <span class=nx>tcpServerTransport</span><span class=p>.</span><span class=nf>SetDefaults</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>DialTimeout</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>       <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>DialKeepAlive</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>       <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TerminationDelay</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>       <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=kd>var</span> <span class=nx>rootCAs</span> <span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>FileOrContent</span>  
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>secret</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>RootCAsSecrets</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=nx>caSecret</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>loadCASecret</span><span class=p>(</span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>secret</span><span class=p>,</span> <span class=nx>client</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>               <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Str</span><span class=p>(</span><span class=s>&#34;rootCAs&#34;</span><span class=p>,</span> <span class=nx>secret</span><span class=p>).</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Error while loading rootCAs&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>               <span class=k>continue</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=nx>rootCAs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>rootCAs</span><span class=p>,</span> <span class=nx>types</span><span class=p>.</span><span class=nf>FileOrContent</span><span class=p>(</span><span class=nx>caSecret</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=kd>var</span> <span class=nx>certs</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>Certificates</span>  
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>secret</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>CertificatesSecrets</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=nx>tlsCert</span><span class=p>,</span> <span class=nx>tlsKey</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>loadAuthTLSSecret</span><span class=p>(</span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>secret</span><span class=p>,</span> <span class=nx>client</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>               <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Str</span><span class=p>(</span><span class=s>&#34;certificates&#34;</span><span class=p>,</span> <span class=nx>secret</span><span class=p>).</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Error while loading certificates&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>               <span class=k>continue</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=nx>certs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>certs</span><span class=p>,</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>Certificate</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>               <span class=nx>CertFile</span><span class=p>:</span> <span class=nx>types</span><span class=p>.</span><span class=nf>FileOrContent</span><span class=p>(</span><span class=nx>tlsCert</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>               <span class=nx>KeyFile</span><span class=p>:</span>  <span class=nx>types</span><span class=p>.</span><span class=nf>FileOrContent</span><span class=p>(</span><span class=nx>tlsKey</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>            <span class=p>})</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=nx>tcpServerTransport</span><span class=p>.</span><span class=nx>TLS</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>TLSClientConfig</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=nx>ServerName</span><span class=p>:</span>         <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>ServerName</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>            <span class=nx>InsecureSkipVerify</span><span class=p>:</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>InsecureSkipVerify</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>            <span class=nx>RootCAs</span><span class=p>:</span>            <span class=nx>rootCAs</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>            <span class=nx>Certificates</span><span class=p>:</span>       <span class=nx>certs</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>            <span class=nx>PeerCertURI</span><span class=p>:</span>        <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>PeerCertURI</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=nx>tcpServerTransport</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>Spiffe</span> <span class=p>=</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>Spiffe</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=nx>id</span> <span class=o>:=</span> <span class=nx>provider</span><span class=p>.</span><span class=nf>Normalize</span><span class=p>(</span><span class=nf>makeID</span><span class=p>(</span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Name</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>      <span class=nx>conf</span><span class=p>.</span><span class=nx>TCP</span><span class=p>.</span><span class=nx>ServersTransports</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>tcpServerTransport</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>2.4. Configuration Updates:</strong></p><p>Providers transmit the Traefik-ready configurations to the watcher through <code>configurationChan</code>. The watcher then consolidates these updates and forwards them to the listener for application.</p><p>This process ensures that Traefik dynamically updates its routing rules and configurations to align with the evolving state of the Kubernetes cluster.</p><p><strong>3. Switcher:</strong></p><p>The essence of the switcher is the combination of sync.Map + interface{}, the purpose of which is to obtain and dynamically update the handler in a thread-safe manner.</p><p><code>pkg/safe/safe.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Safe encapsulates a thread-safe value.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Safe</span> <span class=kd>struct</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>value</span> <span class=kd>interface</span><span class=p>{}</span>  
</span></span><span class=line><span class=cl>   <span class=nx>lock</span>  <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>pkg/server/server_entrypoint_tcp.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>createHTTPServer</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>ln</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Listener</span><span class=p>,</span> <span class=nx>configuration</span> <span class=o>*</span><span class=nx>static</span><span class=p>.</span><span class=nx>EntryPoint</span><span class=p>,</span> <span class=nx>withH2c</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>reqDecorator</span> <span class=o>*</span><span class=nx>requestdecorator</span><span class=p>.</span><span class=nx>RequestDecorator</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>httpServer</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>configuration</span><span class=p>.</span><span class=nx>HTTP2</span><span class=p>.</span><span class=nx>MaxConcurrentStreams</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;max concurrent streams value must be greater than or equal to zero&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>httpSwitcher</span> <span class=o>:=</span> <span class=nx>middlewares</span><span class=p>.</span><span class=nf>NewHandlerSwitcher</span><span class=p>(</span><span class=nx>router</span><span class=p>.</span><span class=nf>BuildDefaultHTTPRouter</span><span class=p>())</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>next</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>alice</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>requestdecorator</span><span class=p>.</span><span class=nf>WrapHandler</span><span class=p>(</span><span class=nx>reqDecorator</span><span class=p>)).</span><span class=nf>Then</span><span class=p>(</span><span class=nx>httpSwitcher</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span></code></pre></div><p><code>pkg/middlewares/handler_switcher.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewHandlerSwitcher builds a new instance of HTTPHandlerSwitcher.  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewHandlerSwitcher</span><span class=p>(</span><span class=nx>newHandler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=p>(</span><span class=nx>hs</span> <span class=o>*</span><span class=nx>HTTPHandlerSwitcher</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=o>&amp;</span><span class=nx>HTTPHandlerSwitcher</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>handler</span><span class=p>:</span> <span class=nx>safe</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>newHandler</span><span class=p>),</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>HTTPHandlerSwitcher</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>rw</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>handlerBackup</span> <span class=o>:=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>Get</span><span class=p>().(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=nx>handlerBackup</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>rw</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// GetHandler returns the current http.ServeMux.  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>HTTPHandlerSwitcher</span><span class=p>)</span> <span class=nf>GetHandler</span><span class=p>()</span> <span class=p>(</span><span class=nx>newHandler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>handler</span> <span class=o>:=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>Get</span><span class=p>().(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>handler</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// UpdateHandler safely updates the current http.ServeMux with a new one.func (h *HTTPHandlerSwitcher) UpdateHandler(newHandler http.Handler) {  
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>h</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>newHandler</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=health-checks-ensuring-availability>Health Checks: Ensuring Availability<a hidden class=anchor aria-hidden=true href=#health-checks-ensuring-availability>#</a></h3><p>Traefik conducts health checks on both itself and backend services to guarantee that traffic is routed only to operational instances.</p><h4 id=self-health-check>Self Health Check<a hidden class=anchor aria-hidden=true href=#self-health-check>#</a></h4><p>Traefik implements self-health checks through the <code>/ping</code> endpoint. This endpoint can be invoked by external systems to ascertain Traefik&rsquo;s health status.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Do try to do a healthcheck.func Do(staticConfiguration static.Configuration) (*http.Response, error) {  
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>staticConfiguration</span><span class=p>.</span><span class=nx>Ping</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;please enable `ping` to use health check&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>ep</span> <span class=o>:=</span> <span class=nx>staticConfiguration</span><span class=p>.</span><span class=nx>Ping</span><span class=p>.</span><span class=nx>EntryPoint</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>ep</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>ep</span> <span class=p>=</span> <span class=s>&#34;traefik&#34;</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>pingEntryPoint</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>staticConfiguration</span><span class=p>.</span><span class=nx>EntryPoints</span><span class=p>[</span><span class=nx>ep</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ping: missing %s entry point&#34;</span><span class=p>,</span> <span class=nx>ep</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>client</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{</span><span class=nx>Timeout</span><span class=p>:</span> <span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=nx>protocol</span> <span class=o>:=</span> <span class=s>&#34;http&#34;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>path</span> <span class=o>:=</span> <span class=s>&#34;/&#34;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Head</span><span class=p>(</span><span class=nx>protocol</span> <span class=o>+</span> <span class=s>&#34;://&#34;</span> <span class=o>+</span> <span class=nx>pingEntryPoint</span><span class=p>.</span><span class=nf>GetAddress</span><span class=p>()</span> <span class=o>+</span> <span class=nx>path</span> <span class=o>+</span> <span class=s>&#34;ping&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This endpoint returns a 200 OK status when Traefik is operational. A failed health check results in a non-200 status code, signaling an issue.</p><h4 id=backend-service-health-checks>Backend Service Health Checks<a hidden class=anchor aria-hidden=true href=#backend-service-health-checks>#</a></h4><p>Traefik supports health checks for backend services across HTTP, HTTPS, and gRPC protocols. Configurable health checks enable the assessment of backend server availability.</p><p>The following is an abridged version of how Traefik conducts backend service health checks:</p><ol><li><strong>Configuration:</strong> Health check specifics are set in the service configuration, detailing parameters like the health check path, interval, and timeout.</li><li><strong>Health Checker:</strong> A ServiceHealthChecker is instantiated for each service with enabled health checks.</li><li><strong>Periodic Checks:</strong> The health checker periodically sends requests to backend servers based on the interval setting.</li><li><strong>Status Updates:</strong> The health checker updates each server&rsquo;s status according to the health check response.</li><li><strong>Load Balancer Updates:</strong> The loader balancer is notified of any status changes, which it considers when distributing requests.</li></ol><p>Here&rsquo;s a snippet of the Go code for the ServiceHealthChecker:
<code>pkg/healthcheck/healthcheck.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewServiceHealthChecker</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>metrics</span> <span class=nx>metricsHealthCheck</span><span class=p>,</span> <span class=nx>config</span> <span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServerHealthCheck</span><span class=p>,</span> <span class=nx>service</span> <span class=nx>StatusSetter</span><span class=p>,</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>ServiceInfo</span><span class=p>,</span> <span class=nx>transport</span> <span class=nx>http</span><span class=p>.</span><span class=nx>RoundTripper</span><span class=p>,</span> <span class=nx>targets</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=o>*</span><span class=nx>ServiceHealthChecker</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>interval</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Interval</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>interval</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Health check interval smaller than zero&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=nx>interval</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>DefaultHealthCheckInterval</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>timeout</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Timeout</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>timeout</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Health check timeout smaller than zero&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=nx>timeout</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>DefaultHealthCheckTimeout</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>client</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>Transport</span><span class=p>:</span> <span class=nx>transport</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>FollowRedirects</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>FollowRedirects</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>.</span><span class=nx>CheckRedirect</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>via</span> <span class=p>[]</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrUseLastResponse</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=o>&amp;</span><span class=nx>ServiceHealthChecker</span><span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>balancer</span><span class=p>:</span> <span class=nx>service</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>info</span><span class=p>:</span>     <span class=nx>info</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>config</span><span class=p>:</span>   <span class=nx>config</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>interval</span><span class=p>:</span> <span class=nx>interval</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>timeout</span><span class=p>:</span>  <span class=nx>timeout</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>targets</span><span class=p>:</span>  <span class=nx>targets</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>:</span>   <span class=nx>client</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>      <span class=nx>metrics</span><span class=p>:</span>  <span class=nx>metrics</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>shc</span> <span class=o>*</span><span class=nx>ServiceHealthChecker</span><span class=p>)</span> <span class=nf>Launch</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>ticker</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=nx>shc</span><span class=p>.</span><span class=nx>interval</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>defer</span> <span class=nx>ticker</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>select</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>  
</span></span><span class=line><span class=cl>         <span class=k>return</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ticker</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=nx>proxyName</span><span class=p>,</span> <span class=nx>target</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>shc</span><span class=p>.</span><span class=nx>targets</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>  
</span></span><span class=line><span class=cl>               <span class=k>return</span>  
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=nx>up</span> <span class=o>:=</span> <span class=kc>true</span>  
</span></span><span class=line><span class=cl>            <span class=nx>serverUpMetricValue</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>shc</span><span class=p>.</span><span class=nf>executeHealthCheck</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>               <span class=c1>// The context is canceled when the dynamic configuration is refreshed.  
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Canceled</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>                  <span class=k>return</span>  
</span></span><span class=line><span class=cl>               <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>               <span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Warn</span><span class=p>().</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Str</span><span class=p>(</span><span class=s>&#34;targetURL&#34;</span><span class=p>,</span> <span class=nx>target</span><span class=p>.</span><span class=nf>String</span><span class=p>()).</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span>  
</span></span><span class=line><span class=cl>                  <span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Health check failed.&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>               <span class=nx>up</span> <span class=p>=</span> <span class=kc>false</span>  
</span></span><span class=line><span class=cl>               <span class=nx>serverUpMetricValue</span> <span class=p>=</span> <span class=nb>float64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=nx>shc</span><span class=p>.</span><span class=nx>balancer</span><span class=p>.</span><span class=nf>SetStatus</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>proxyName</span><span class=p>,</span> <span class=nx>up</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=nx>statusStr</span> <span class=o>:=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>StatusDown</span>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>up</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>               <span class=nx>statusStr</span> <span class=p>=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>StatusUp</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=nx>shc</span><span class=p>.</span><span class=nx>info</span><span class=p>.</span><span class=nf>UpdateServerStatus</span><span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>statusStr</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>            <span class=nx>shc</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>ServiceServerUpGauge</span><span class=p>().</span>  
</span></span><span class=line><span class=cl>               <span class=nf>With</span><span class=p>(</span><span class=s>&#34;service&#34;</span><span class=p>,</span> <span class=nx>proxyName</span><span class=p>,</span> <span class=s>&#34;url&#34;</span><span class=p>,</span> <span class=nx>target</span><span class=p>.</span><span class=nf>String</span><span class=p>()).</span>  
</span></span><span class=line><span class=cl>               <span class=nf>Set</span><span class=p>(</span><span class=nx>serverUpMetricValue</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>shc</span> <span class=o>*</span><span class=nx>ServiceHealthChecker</span><span class=p>)</span> <span class=nf>executeHealthCheck</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>config</span> <span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServerHealthCheck</span><span class=p>,</span> <span class=nx>target</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithDeadline</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>shc</span><span class=p>.</span><span class=nx>timeout</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>   <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Mode</span> <span class=o>==</span> <span class=nx>modeGRPC</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>shc</span><span class=p>.</span><span class=nf>checkHealthGRPC</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>shc</span><span class=p>.</span><span class=nf>checkHealthHTTP</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// checkHealthHTTP returns an error with a meaningful description if the health check failed.// Dedicated to HTTP servers.  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>shc</span> <span class=o>*</span><span class=nx>ServiceHealthChecker</span><span class=p>)</span> <span class=nf>checkHealthHTTP</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>target</span> <span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>req</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>shc</span><span class=p>.</span><span class=nf>newRequest</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;create HTTP request: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>shc</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;HTTP request failed: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Status</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=p>&lt;</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span> <span class=o>||</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=o>&gt;=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;received error status code: %v&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Status</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Status</span> <span class=o>!=</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;received error status code: %v expected status code: %v&#34;</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>,</span> <span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>nil</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This code illustrates the health checker dispatching a health check request and updating the server status based on the response. The load balancer then uses this information to direct traffic only to responsive servers.</p><h3 id=middleware-enhancing-the-routing-process>Middleware: Enhancing the Routing Process<a hidden class=anchor aria-hidden=true href=#middleware-enhancing-the-routing-process>#</a></h3><p>Traefik&rsquo;s middleware system allows for the injection of additional functionality into the request/response lifecycle. Middlewares can be linked to routers or services to perform tasks such as authentication, rate limiting, and request transformation.</p><p>Traefik provides an extensive range of built-in middlewares, and custom middlewares can be integrated via plugins.</p><h4 id=middleware-processing-pipeline>Middleware Processing Pipeline<a hidden class=anchor aria-hidden=true href=#middleware-processing-pipeline>#</a></h4><p>The following outlines how Traefik processes middlewares:</p><ol><li><strong>Configuration:</strong> Middlewares are defined in the dynamic configuration and linked to routers or services.</li><li><strong>Middleware Chain:</strong> A chain of middlewares is constructed based on the configuration, with the order determining their execution sequence.</li><li><strong>Request Processing:</strong> Incoming requests traverse the middleware chain before reaching the backend service, allowing each middleware to alter the request or generate a response.</li><li><strong>Response Processing:</strong> After the backend service responds, the response is pushed back through the middleware chain in reverse order, permitting modification before reaching the client.</li></ol><h4 id=source-code-analysis-middleware-builder>Source Code Analysis: Middleware Builder<a hidden class=anchor aria-hidden=true href=#source-code-analysis-middleware-builder>#</a></h4><p>The middleware.Builder is responsible for constructing the middleware chain from the configuration. It provides a BuildChain function that accepts a context and a list of middleware names, returning an alice.Chain object.</p><p>Here&rsquo;s an abridged version of the BuildChain function:
<code>pkg/server/middleware/middlewares.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>Builder</span><span class=p>)</span> <span class=nf>BuildChain</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>middlewares</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>alice</span><span class=p>.</span><span class=nx>Chain</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>chain</span> <span class=o>:=</span> <span class=nx>alice</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>name</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>middlewares</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>middlewareName</span> <span class=o>:=</span> <span class=nx>provider</span><span class=p>.</span><span class=nf>GetQualifiedName</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>name</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=nx>chain</span> <span class=p>=</span> <span class=nx>chain</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>next</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>constructorContext</span> <span class=o>:=</span> <span class=nx>provider</span><span class=p>.</span><span class=nf>AddInContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>midInf</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>];</span> <span class=p>!</span><span class=nx>ok</span> <span class=o>||</span> <span class=nx>midInf</span><span class=p>.</span><span class=nx>Middleware</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;middleware %q does not exist&#34;</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>  
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>constructorContext</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>checkRecursion</span><span class=p>(</span><span class=nx>constructorContext</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>].</span><span class=nf>AddError</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=nx>constructor</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nf>buildConstructor</span><span class=p>(</span><span class=nx>constructorContext</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>].</span><span class=nf>AddError</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=nx>handler</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>constructor</span><span class=p>(</span><span class=nx>next</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>].</span><span class=nf>AddError</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>  
</span></span><span class=line><span class=cl>         <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=nx>handler</span><span class=p>,</span> <span class=kc>nil</span>  
</span></span><span class=line><span class=cl>      <span class=p>})</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=o>&amp;</span><span class=nx>chain</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>checkRecursion</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>middlewareName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>currentStack</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=nx>middlewareStackKey</span><span class=p>).([]</span><span class=kt>string</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>currentStack</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nf>inSlice</span><span class=p>(</span><span class=nx>middlewareName</span><span class=p>,</span> <span class=nx>currentStack</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not instantiate middleware %s: recursion detected in %s&#34;</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>currentStack</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>),</span> <span class=s>&#34;-&gt;&#34;</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>middlewareStackKey</span><span class=p>,</span> <span class=nb>append</span><span class=p>(</span><span class=nx>currentStack</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>)),</span> <span class=kc>nil</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>// it is the responsibility of the caller to make sure that b.configs[middlewareName].Middleware exists.  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>Builder</span><span class=p>)</span> <span class=nf>buildConstructor</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>middlewareName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>alice</span><span class=p>.</span><span class=nx>Constructor</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>config</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>config</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Middleware</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid middleware %q configuration&#34;</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>middleware</span> <span class=nx>alice</span><span class=p>.</span><span class=nx>Constructor</span>  
</span></span><span class=line><span class=cl>   <span class=nx>badConf</span> <span class=o>:=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;cannot create middleware: multi-types middleware not supported, consider declaring two different pieces of middleware instead&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Chain  
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Chain</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>middleware</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>badConf</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>qualifiedNames</span> <span class=p>[]</span><span class=kt>string</span>  
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>name</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Chain</span><span class=p>.</span><span class=nx>Middlewares</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=nx>qualifiedNames</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>qualifiedNames</span><span class=p>,</span> <span class=nx>provider</span><span class=p>.</span><span class=nf>GetQualifiedName</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>      <span class=nx>config</span><span class=p>.</span><span class=nx>Chain</span><span class=p>.</span><span class=nx>Middlewares</span> <span class=p>=</span> <span class=nx>qualifiedNames</span>  
</span></span><span class=line><span class=cl>      <span class=nx>middleware</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>next</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=nx>chain</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>next</span><span class=p>,</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>Chain</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>      <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=o>...</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>middleware</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid middleware %q configuration: invalid middleware type or middleware does not exist&#34;</span><span class=p>,</span> <span class=nx>middlewareName</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=c1>// The tracing middleware is a NOOP if tracing is not setup on the middleware chain.  
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// Hence, regarding internal resources&#39; observability deactivation,   // this would not enable tracing.   return tracing.WrapMiddleware(ctx, middleware), nil  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>This function iterates through middleware names to build a chain of constructors. Each constructor is tasked with creating a middleware instance and integrating it with the next handler in the chain.</p><p>The buildConstructor function creates the constructor for a specific middleware based on its configuration, applying reflection to identify the middleware type and instantiate the relevant function.</p><p>This methodology enables Traefik to support a diverse array of middlewares with varying configurations, while promoting a well-organized and modular codebase.</p><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>Traefik&rsquo;s architecture and source code exemplify a systematic and modular approach to managing static and dynamic configurations, provider integration, and health checks. Understanding these core principles and code elements empowers users to effectively harness Traefik for orchestrating complex deployments.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zhoukuncheng.github.io/tags/golang/>Golang</a></li><li><a href=https://zhoukuncheng.github.io/tags/traefik/>Traefik</a></li></ul></footer><script src=https://giscus.app/client.js data-repo=zhoukuncheng/zhoukuncheng.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyODIxMTA1OTU=" data-category=General data-category-id=DIC_kwDOENCqg84Cexta data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=purple_dark data-lang=en crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://zhoukuncheng.github.io/>zhoukuncheng's Personal Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>