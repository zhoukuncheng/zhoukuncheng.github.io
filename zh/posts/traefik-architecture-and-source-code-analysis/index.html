<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Traefik 架构与源码分析：深度探索 | zhoukuncheng's Personal Blog</title><meta name=keywords content="Golang,Traefik"><meta name=description content="
Traefik 是一个被广泛采用的开源 HTTP 反向代理和负载均衡器，它简化了现代 Web 应用程序的路由和请求负载均衡。它拥有动态配置功能，并支持众多提供商 (providers)，定位为编排复杂部署场景的多功能解决方案。在这篇博文中，我们将深入探讨 Traefik 的架构，并剖析其源代码的关键组件，以便更细致地了解其运行机制。
Traefik 架构：高层概述
在其核心，Traefik 的架构由几个主要组件组成，这些组件协同工作以促进动态路由和负载均衡：


静态配置 (Static Configuration): 这些是 Traefik 的基础设置，包括入口点 (entry points)、提供商 (providers) 和 API 访问配置。它们可以通过文件、命令行参数或环境变量来指定。


动态配置 (Dynamic Configuration): 这涉及可根据基础设施状态进行调整的路由规则、服务和中间件。Traefik 与多种提供商（如 Docker、Kubernetes、Consul Catalog 等）的兼容性突显了其动态特性。


提供商 (Providers): 作为 Traefik 与服务发现机制之间的桥梁，提供商的任务是获取并将动态配置传递给 Traefik。每个提供商都是为集成不同技术（如 Docker、Kubernetes 和 Consul）而定制的。


入口点 (Entry Points): 这些指定了 Traefik 监听入站流量的网络接口（端口和协议）。


路由器 (Routers): 路由器建立通过各种参数（如主机名、路径和头部）匹配传入请求的标准。它们负责将请求引导至适当的服务。


服务 (Services): 服务定义了 Traefik 与处理请求的后端系统进行通信的机制。可以通过不同的负载均衡策略和健康检查对服务进行微调。


中间件 (Middlewares): 作为模块化实体，中间件可以附加到路由器或服务上，启用一系列功能，包括身份验证、速率限制和请求修改。


插件 (Plugins): Traefik 可以通过插件进行扩展，从而增强其功能。插件系统允许开发人员贡献自定义插件。


这些组件的编排如下：

Traefik 摄取静态配置并开始监控指定的入口点。
提供商持续扫描基础设施以查找配置更改，并通过动态配置通道将其转发给 Traefik。
Traefik 处理动态配置，更新其内部结构——路由器、服务和中间件——以反映这些更改。
当请求进入时，Traefik 根据路由器规则对其进行匹配，并将其引导至指定的服务。
服务应用其负载均衡逻辑将请求分发到后端服务器。
中间件可以在请求/响应生命周期的各个阶段被调用，以执行其各自的职责。

这种动态架构使 Traefik 能够敏捷地适应基础设施内的变化，自动调整路由配置以与已部署的服务保持一致。"><meta name=author content="zhoukuncheng"><link rel=canonical href=https://zhoukuncheng.github.io/zh/posts/traefik-architecture-and-source-code-analysis/><link crossorigin=anonymous href=/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css integrity="sha256-NDzEgLn/yPBMy+XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as=style><link rel=icon href=https://zhoukuncheng.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zhoukuncheng.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zhoukuncheng.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zhoukuncheng.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zhoukuncheng.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://zhoukuncheng.github.io/zh/posts/traefik-architecture-and-source-code-analysis/><link rel=alternate hreflang=en href=https://zhoukuncheng.github.io/posts/traefik-architecture-and-source-code-analysis/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GH88YSLNJN"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GH88YSLNJN")}</script><meta property="og:url" content="https://zhoukuncheng.github.io/zh/posts/traefik-architecture-and-source-code-analysis/"><meta property="og:site_name" content="zhoukuncheng's Personal Blog"><meta property="og:title" content="Traefik 架构与源码分析：深度探索"><meta property="og:description" content="
Traefik 是一个被广泛采用的开源 HTTP 反向代理和负载均衡器，它简化了现代 Web 应用程序的路由和请求负载均衡。它拥有动态配置功能，并支持众多提供商 (providers)，定位为编排复杂部署场景的多功能解决方案。在这篇博文中，我们将深入探讨 Traefik 的架构，并剖析其源代码的关键组件，以便更细致地了解其运行机制。
Traefik 架构：高层概述 在其核心，Traefik 的架构由几个主要组件组成，这些组件协同工作以促进动态路由和负载均衡：
静态配置 (Static Configuration): 这些是 Traefik 的基础设置，包括入口点 (entry points)、提供商 (providers) 和 API 访问配置。它们可以通过文件、命令行参数或环境变量来指定。
动态配置 (Dynamic Configuration): 这涉及可根据基础设施状态进行调整的路由规则、服务和中间件。Traefik 与多种提供商（如 Docker、Kubernetes、Consul Catalog 等）的兼容性突显了其动态特性。
提供商 (Providers): 作为 Traefik 与服务发现机制之间的桥梁，提供商的任务是获取并将动态配置传递给 Traefik。每个提供商都是为集成不同技术（如 Docker、Kubernetes 和 Consul）而定制的。
入口点 (Entry Points): 这些指定了 Traefik 监听入站流量的网络接口（端口和协议）。
路由器 (Routers): 路由器建立通过各种参数（如主机名、路径和头部）匹配传入请求的标准。它们负责将请求引导至适当的服务。
服务 (Services): 服务定义了 Traefik 与处理请求的后端系统进行通信的机制。可以通过不同的负载均衡策略和健康检查对服务进行微调。
中间件 (Middlewares): 作为模块化实体，中间件可以附加到路由器或服务上，启用一系列功能，包括身份验证、速率限制和请求修改。
插件 (Plugins): Traefik 可以通过插件进行扩展，从而增强其功能。插件系统允许开发人员贡献自定义插件。
这些组件的编排如下：
Traefik 摄取静态配置并开始监控指定的入口点。 提供商持续扫描基础设施以查找配置更改，并通过动态配置通道将其转发给 Traefik。 Traefik 处理动态配置，更新其内部结构——路由器、服务和中间件——以反映这些更改。 当请求进入时，Traefik 根据路由器规则对其进行匹配，并将其引导至指定的服务。 服务应用其负载均衡逻辑将请求分发到后端服务器。 中间件可以在请求/响应生命周期的各个阶段被调用，以执行其各自的职责。 这种动态架构使 Traefik 能够敏捷地适应基础设施内的变化，自动调整路由配置以与已部署的服务保持一致。"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-09T14:54:00+08:00"><meta property="article:modified_time" content="2024-03-09T14:54:00+08:00"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Traefik"><meta name=twitter:card content="summary"><meta name=twitter:title content="Traefik 架构与源码分析：深度探索"><meta name=twitter:description content="
Traefik 是一个被广泛采用的开源 HTTP 反向代理和负载均衡器，它简化了现代 Web 应用程序的路由和请求负载均衡。它拥有动态配置功能，并支持众多提供商 (providers)，定位为编排复杂部署场景的多功能解决方案。在这篇博文中，我们将深入探讨 Traefik 的架构，并剖析其源代码的关键组件，以便更细致地了解其运行机制。
Traefik 架构：高层概述
在其核心，Traefik 的架构由几个主要组件组成，这些组件协同工作以促进动态路由和负载均衡：


静态配置 (Static Configuration): 这些是 Traefik 的基础设置，包括入口点 (entry points)、提供商 (providers) 和 API 访问配置。它们可以通过文件、命令行参数或环境变量来指定。


动态配置 (Dynamic Configuration): 这涉及可根据基础设施状态进行调整的路由规则、服务和中间件。Traefik 与多种提供商（如 Docker、Kubernetes、Consul Catalog 等）的兼容性突显了其动态特性。


提供商 (Providers): 作为 Traefik 与服务发现机制之间的桥梁，提供商的任务是获取并将动态配置传递给 Traefik。每个提供商都是为集成不同技术（如 Docker、Kubernetes 和 Consul）而定制的。


入口点 (Entry Points): 这些指定了 Traefik 监听入站流量的网络接口（端口和协议）。


路由器 (Routers): 路由器建立通过各种参数（如主机名、路径和头部）匹配传入请求的标准。它们负责将请求引导至适当的服务。


服务 (Services): 服务定义了 Traefik 与处理请求的后端系统进行通信的机制。可以通过不同的负载均衡策略和健康检查对服务进行微调。


中间件 (Middlewares): 作为模块化实体，中间件可以附加到路由器或服务上，启用一系列功能，包括身份验证、速率限制和请求修改。


插件 (Plugins): Traefik 可以通过插件进行扩展，从而增强其功能。插件系统允许开发人员贡献自定义插件。


这些组件的编排如下：

Traefik 摄取静态配置并开始监控指定的入口点。
提供商持续扫描基础设施以查找配置更改，并通过动态配置通道将其转发给 Traefik。
Traefik 处理动态配置，更新其内部结构——路由器、服务和中间件——以反映这些更改。
当请求进入时，Traefik 根据路由器规则对其进行匹配，并将其引导至指定的服务。
服务应用其负载均衡逻辑将请求分发到后端服务器。
中间件可以在请求/响应生命周期的各个阶段被调用，以执行其各自的职责。

这种动态架构使 Traefik 能够敏捷地适应基础设施内的变化，自动调整路由配置以与已部署的服务保持一致。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zhoukuncheng.github.io/zh/posts/"},{"@type":"ListItem","position":2,"name":"Traefik 架构与源码分析：深度探索","item":"https://zhoukuncheng.github.io/zh/posts/traefik-architecture-and-source-code-analysis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Traefik 架构与源码分析：深度探索","name":"Traefik 架构与源码分析：深度探索","description":"\nTraefik 是一个被广泛采用的开源 HTTP 反向代理和负载均衡器，它简化了现代 Web 应用程序的路由和请求负载均衡。它拥有动态配置功能，并支持众多提供商 (providers)，定位为编排复杂部署场景的多功能解决方案。在这篇博文中，我们将深入探讨 Traefik 的架构，并剖析其源代码的关键组件，以便更细致地了解其运行机制。\nTraefik 架构：高层概述 在其核心，Traefik 的架构由几个主要组件组成，这些组件协同工作以促进动态路由和负载均衡：\n静态配置 (Static Configuration): 这些是 Traefik 的基础设置，包括入口点 (entry points)、提供商 (providers) 和 API 访问配置。它们可以通过文件、命令行参数或环境变量来指定。\n动态配置 (Dynamic Configuration): 这涉及可根据基础设施状态进行调整的路由规则、服务和中间件。Traefik 与多种提供商（如 Docker、Kubernetes、Consul Catalog 等）的兼容性突显了其动态特性。\n提供商 (Providers): 作为 Traefik 与服务发现机制之间的桥梁，提供商的任务是获取并将动态配置传递给 Traefik。每个提供商都是为集成不同技术（如 Docker、Kubernetes 和 Consul）而定制的。\n入口点 (Entry Points): 这些指定了 Traefik 监听入站流量的网络接口（端口和协议）。\n路由器 (Routers): 路由器建立通过各种参数（如主机名、路径和头部）匹配传入请求的标准。它们负责将请求引导至适当的服务。\n服务 (Services): 服务定义了 Traefik 与处理请求的后端系统进行通信的机制。可以通过不同的负载均衡策略和健康检查对服务进行微调。\n中间件 (Middlewares): 作为模块化实体，中间件可以附加到路由器或服务上，启用一系列功能，包括身份验证、速率限制和请求修改。\n插件 (Plugins): Traefik 可以通过插件进行扩展，从而增强其功能。插件系统允许开发人员贡献自定义插件。\n这些组件的编排如下：\nTraefik 摄取静态配置并开始监控指定的入口点。 提供商持续扫描基础设施以查找配置更改，并通过动态配置通道将其转发给 Traefik。 Traefik 处理动态配置，更新其内部结构——路由器、服务和中间件——以反映这些更改。 当请求进入时，Traefik 根据路由器规则对其进行匹配，并将其引导至指定的服务。 服务应用其负载均衡逻辑将请求分发到后端服务器。 中间件可以在请求/响应生命周期的各个阶段被调用，以执行其各自的职责。 这种动态架构使 Traefik 能够敏捷地适应基础设施内的变化，自动调整路由配置以与已部署的服务保持一致。\n","keywords":["Golang","Traefik"],"articleBody":"\nTraefik 是一个被广泛采用的开源 HTTP 反向代理和负载均衡器，它简化了现代 Web 应用程序的路由和请求负载均衡。它拥有动态配置功能，并支持众多提供商 (providers)，定位为编排复杂部署场景的多功能解决方案。在这篇博文中，我们将深入探讨 Traefik 的架构，并剖析其源代码的关键组件，以便更细致地了解其运行机制。\nTraefik 架构：高层概述 在其核心，Traefik 的架构由几个主要组件组成，这些组件协同工作以促进动态路由和负载均衡：\n静态配置 (Static Configuration): 这些是 Traefik 的基础设置，包括入口点 (entry points)、提供商 (providers) 和 API 访问配置。它们可以通过文件、命令行参数或环境变量来指定。\n动态配置 (Dynamic Configuration): 这涉及可根据基础设施状态进行调整的路由规则、服务和中间件。Traefik 与多种提供商（如 Docker、Kubernetes、Consul Catalog 等）的兼容性突显了其动态特性。\n提供商 (Providers): 作为 Traefik 与服务发现机制之间的桥梁，提供商的任务是获取并将动态配置传递给 Traefik。每个提供商都是为集成不同技术（如 Docker、Kubernetes 和 Consul）而定制的。\n入口点 (Entry Points): 这些指定了 Traefik 监听入站流量的网络接口（端口和协议）。\n路由器 (Routers): 路由器建立通过各种参数（如主机名、路径和头部）匹配传入请求的标准。它们负责将请求引导至适当的服务。\n服务 (Services): 服务定义了 Traefik 与处理请求的后端系统进行通信的机制。可以通过不同的负载均衡策略和健康检查对服务进行微调。\n中间件 (Middlewares): 作为模块化实体，中间件可以附加到路由器或服务上，启用一系列功能，包括身份验证、速率限制和请求修改。\n插件 (Plugins): Traefik 可以通过插件进行扩展，从而增强其功能。插件系统允许开发人员贡献自定义插件。\n这些组件的编排如下：\nTraefik 摄取静态配置并开始监控指定的入口点。 提供商持续扫描基础设施以查找配置更改，并通过动态配置通道将其转发给 Traefik。 Traefik 处理动态配置，更新其内部结构——路由器、服务和中间件——以反映这些更改。 当请求进入时，Traefik 根据路由器规则对其进行匹配，并将其引导至指定的服务。 服务应用其负载均衡逻辑将请求分发到后端服务器。 中间件可以在请求/响应生命周期的各个阶段被调用，以执行其各自的职责。 这种动态架构使 Traefik 能够敏捷地适应基础设施内的变化，自动调整路由配置以与已部署的服务保持一致。\n源码分析：关键组件 现在，让我们检查 Traefik 源代码中的一些关键组件：\n1. Watcher 和 Listener:\nWatcher 和 Listener 协作以检测和执行动态配置更改。Watcher 负责不断调查配置源并将更新推送到 Listener。随后，Listener 验证这些更新并将它们与 Traefik 的内部状态集成。\nWatcher:\npkg/server/configurationwatcher.go\n// NewConfigurationWatcher creates a new ConfigurationWatcher. func NewConfigurationWatcher( routinesPool *safe.Pool, pvd provider.Provider, defaultEntryPoints []string, requiredProvider string, ) *ConfigurationWatcher { return \u0026ConfigurationWatcher{ providerAggregator: pvd, allProvidersConfigs: make(chan dynamic.Message, 100), newConfigs: make(chan dynamic.Configurations), routinesPool: routinesPool, defaultEntryPoints: defaultEntryPoints, requiredProvider: requiredProvider, } } // Start the configuration watcher. func (c *ConfigurationWatcher) Start() { c.routinesPool.GoCtx(c.receiveConfigurations) c.routinesPool.GoCtx(c.applyConfigurations) c.startProviderAggregator() } // Stop the configuration watcher. func (c *ConfigurationWatcher) Stop() { close(c.allProvidersConfigs) close(c.newConfigs) } // AddListener adds a new listener function used when new configuration is provided. func (c *ConfigurationWatcher) AddListener(listener func(dynamic.Configuration)) { if c.configurationListeners == nil { c.configurationListeners = make([]func(dynamic.Configuration), 0) } c.configurationListeners = append(c.configurationListeners, listener) } func (c *ConfigurationWatcher) startProviderAggregator() { log.Info().Msgf(\"Starting provider aggregator %T\", c.providerAggregator) safe.Go(func() { err := c.providerAggregator.Provide(c.allProvidersConfigs, c.routinesPool) if err != nil { log.Error().Err(err).Msgf(\"Error starting provider aggregator %T\", c.providerAggregator) } }) } Listener:\ncmd/traefik/traefik.go\n// Server Transports watcher.AddListener(func(conf dynamic.Configuration) { roundTripperManager.Update(conf.HTTP.ServersTransports) dialerManager.Update(conf.TCP.ServersTransports) }) pkg/server/service/roundtripper.go\n// RoundTripperManager handles roundtripper for the reverse proxy. type RoundTripperManager struct { rtLock sync.RWMutex roundTrippers map[string]http.RoundTripper configs map[string]*dynamic.ServersTransport spiffeX509Source SpiffeX509Source } // Update updates the roundtrippers configurations. func (r *RoundTripperManager) Update(newConfigs map[string]*dynamic.ServersTransport) { r.rtLock.Lock() defer r.rtLock.Unlock() for configName, config := range r.configs { newConfig, ok := newConfigs[configName] if !ok { delete(r.configs, configName) delete(r.roundTrippers, configName) continue } if reflect.DeepEqual(newConfig, config) { continue } var err error r.roundTrippers[configName], err = r.createRoundTripper(newConfig) if err != nil { log.Error().Err(err).Msgf(\"Could not configure HTTP Transport %s, fallback on default transport\", configName) r.roundTrippers[configName] = http.DefaultTransport } } for newConfigName, newConfig := range newConfigs { if _, ok := r.configs[newConfigName]; ok { continue } var err error r.roundTrippers[newConfigName], err = r.createRoundTripper(newConfig) if err != nil { log.Error().Err(err).Msgf(\"Could not configure HTTP Transport %s, fallback on default transport\", newConfigName) r.roundTrippers[newConfigName] = http.DefaultTransport } } r.configs = newConfigs } 2. Provider:\nProvider 在 Traefik 的架构中至关重要，它与特定技术接口以发掘并传递配置更新。Provide 函数位于 Provider 角色的核心，管理连接、发现和更新过程。\nKubernetes Provider: 配置发现\nTraefik 中的 Kubernetes 提供商从 Kubernetes API 服务器中提取配置详细信息，监控 Kubernetes 资源（如 Ingress、IngressRoute、Service 和 Middleware 对象）的变化。\n2.1. Kubernetes 客户端初始化:\n提供商初始化一个客户端以连接到 Kubernetes API，利用此客户端与 API 交互并观察资源变化。\npkg/provider/kubernetes/crd/kubernetes.go\nfunc (p *Provider) newK8sClient(ctx context.Context) (*clientWrapper, error) { _, err := labels.Parse(p.LabelSelector) if err != nil { return nil, fmt.Errorf(\"invalid label selector: %q\", p.LabelSelector) } log.Ctx(ctx).Info().Msgf(\"label selector is: %q\", p.LabelSelector) withEndpoint := \"\" if p.Endpoint != \"\" { withEndpoint = fmt.Sprintf(\" with endpoint %s\", p.Endpoint) } var client *clientWrapper switch { case os.Getenv(\"KUBERNETES_SERVICE_HOST\") != \"\" \u0026\u0026 os.Getenv(\"KUBERNETES_SERVICE_PORT\") != \"\": log.Ctx(ctx).Info().Msgf(\"Creating in-cluster Provider client%s\", withEndpoint) client, err = newInClusterClient(p.Endpoint) case os.Getenv(\"KUBECONFIG\") != \"\": log.Ctx(ctx).Info().Msgf(\"Creating cluster-external Provider client from KUBECONFIG %s\", os.Getenv(\"KUBECONFIG\")) client, err = newExternalClusterClientFromFile(os.Getenv(\"KUBECONFIG\")) default: log.Ctx(ctx).Info().Msgf(\"Creating cluster-external Provider client%s\", withEndpoint) client, err = newExternalClusterClient(p.Endpoint, p.CertAuthFilePath, p.Token) } if err != nil { return nil, err } client.labelSelector = p.LabelSelector return client, nil } 2.2. 资源监控 (Resource Watching):\n提供商使用 Kubernetes 客户端来观察相关资源的变化。通常使用 Informers 来有效地跟踪这些资源，并在创建、更新或删除时接收通知。\npkg/provider/kubernetes/crd/kubernetes.go\n// Provide allows the k8s provider to provide configurations to traefik// using the given configuration channel. func (p *Provider) Provide(configurationChan chan\u003c- dynamic.Message, pool *safe.Pool) error { logger := log.With().Str(logs.ProviderName, providerName).Logger() ctxLog := logger.WithContext(context.Background()) k8sClient, err := p.newK8sClient(ctxLog) if err != nil { return err } if p.AllowCrossNamespace { logger.Warn().Msg(\"Cross-namespace reference between IngressRoutes and resources is enabled, please ensure that this is expected (see AllowCrossNamespace option)\") } if p.AllowExternalNameServices { logger.Warn().Msg(\"ExternalName service loading is enabled, please ensure that this is expected (see AllowExternalNameServices option)\") } pool.GoCtx(func(ctxPool context.Context) { operation := func() error { eventsChan, err := k8sClient.WatchAll(p.Namespaces, ctxPool.Done()) if err != nil { logger.Error().Err(err).Msg(\"Error watching kubernetes events\") timer := time.NewTimer(1 * time.Second) select { case \u003c-timer.C: return err case \u003c-ctxPool.Done(): return nil } } throttleDuration := time.Duration(p.ThrottleDuration) throttledChan := throttleEvents(ctxLog, throttleDuration, pool, eventsChan) if throttledChan != nil { eventsChan = throttledChan } for { select { case \u003c-ctxPool.Done(): return nil case event := \u003c-eventsChan: // Note that event is the *first* event that came in during this throttling interval -- if we're hitting our throttle, we may have dropped events. // This is fine, because we don't treat different event types differently. // But if we do in the future, we'll need to track more information about the dropped events. conf := p.loadConfigurationFromCRD(ctxLog, k8sClient) confHash, err := hashstructure.Hash(conf, nil) switch { case err != nil: logger.Error().Err(err).Msg(\"Unable to hash the configuration\") case p.lastConfiguration.Get() == confHash: logger.Debug().Msgf(\"Skipping Kubernetes event kind %T\", event) default: p.lastConfiguration.Set(confHash) configurationChan \u003c- dynamic.Message{ ProviderName: providerName, Configuration: conf, } } // If we're throttling, // we sleep here for the throttle duration to enforce that we don't refresh faster than our throttle. // time.Sleep returns immediately if p.ThrottleDuration is 0 (no throttle). time.Sleep(throttleDuration) } } } notify := func(err error, time time.Duration) { logger.Error().Err(err).Msgf(\"Provider error, retrying in %s\", time) } err := backoff.RetryNotify(safe.OperationWithRecover(operation), backoff.WithContext(job.NewBackOff(backoff.NewExponentialBackOff()), ctxPool), notify) if err != nil { logger.Error().Err(err).Msg(\"Cannot retrieve data\") } }) return nil } 2.3. 配置解析 (Configuration Parsing):\n接收到资源更新后，提供商会解析数据以提取配置详细信息。然后，这些配置被转换为 Traefik 特定的格式，用于路由器、服务和中间件。\npkg/provider/kubernetes/crd/kubernetes.go\nfunc (p *Provider) loadConfigurationFromCRD(ctx context.Context, client Client) *dynamic.Configuration { // ... conf := \u0026dynamic.Configuration{ // TODO: choose between mutating and returning tlsConfigs HTTP: p.loadIngressRouteConfiguration(ctx, client, tlsConfigs), TCP: p.loadIngressRouteTCPConfiguration(ctx, client, tlsConfigs), UDP: p.loadIngressRouteUDPConfiguration(ctx, client), TLS: \u0026dynamic.TLSConfiguration{ Options: buildTLSOptions(ctx, client), Stores: stores, }, } //... conf.HTTP.Middlewares[id] = \u0026dynamic.Middleware{ AddPrefix: middleware.Spec.AddPrefix, StripPrefix: middleware.Spec.StripPrefix, StripPrefixRegex: middleware.Spec.StripPrefixRegex, ReplacePath: middleware.Spec.ReplacePath, ReplacePathRegex: middleware.Spec.ReplacePathRegex, Chain: createChainMiddleware(ctxMid, middleware.Namespace, middleware.Spec.Chain), IPWhiteList: middleware.Spec.IPWhiteList, IPAllowList: middleware.Spec.IPAllowList, Headers: middleware.Spec.Headers, Errors: errorPage, RateLimit: rateLimit, RedirectRegex: middleware.Spec.RedirectRegex, RedirectScheme: middleware.Spec.RedirectScheme, BasicAuth: basicAuth, DigestAuth: digestAuth, ForwardAuth: forwardAuth, InFlightReq: middleware.Spec.InFlightReq, Buffering: middleware.Spec.Buffering, CircuitBreaker: circuitBreaker, Compress: middleware.Spec.Compress, PassTLSClientCert: middleware.Spec.PassTLSClientCert, Retry: retry, ContentType: middleware.Spec.ContentType, GrpcWeb: middleware.Spec.GrpcWeb, Plugin: plugin, } } //... cb := configBuilder{ client: client, allowCrossNamespace: p.AllowCrossNamespace, allowExternalNameServices: p.AllowExternalNameServices, allowEmptyServices: p.AllowEmptyServices, } for _, service := range client.GetTraefikServices() { err := cb.buildTraefikService(ctx, service, conf.HTTP.Services) if err != nil { log.Ctx(ctx).Error().Str(logs.ServiceName, service.Name).Err(err). Msg(\"Error while building TraefikService\") continue } } //... id := provider.Normalize(makeID(serversTransport.Namespace, serversTransport.Name)) conf.HTTP.ServersTransports[id] = \u0026dynamic.ServersTransport{ ServerName: serversTransport.Spec.ServerName, InsecureSkipVerify: serversTransport.Spec.InsecureSkipVerify, RootCAs: rootCAs, Certificates: certs, DisableHTTP2: serversTransport.Spec.DisableHTTP2, MaxIdleConnsPerHost: serversTransport.Spec.MaxIdleConnsPerHost, ForwardingTimeouts: forwardingTimeout, PeerCertURI: serversTransport.Spec.PeerCertURI, Spiffe: serversTransport.Spec.Spiffe, } } // ... for _, serversTransportTCP := range client.GetServersTransportTCPs() { var tcpServerTransport dynamic.TCPServersTransport tcpServerTransport.SetDefaults() if serversTransportTCP.Spec.DialTimeout != nil { // ... } if serversTransportTCP.Spec.DialKeepAlive != nil { // ... } if serversTransportTCP.Spec.TerminationDelay != nil { // ... } if serversTransportTCP.Spec.TLS != nil { var rootCAs []types.FileOrContent for _, secret := range serversTransportTCP.Spec.TLS.RootCAsSecrets { caSecret, err := loadCASecret(serversTransportTCP.Namespace, secret, client) if err != nil { logger.Error(). Err(err). Str(\"rootCAs\", secret). Msg(\"Error while loading rootCAs\") continue } rootCAs = append(rootCAs, types.FileOrContent(caSecret)) } var certs tls.Certificates for _, secret := range serversTransportTCP.Spec.TLS.CertificatesSecrets { tlsCert, tlsKey, err := loadAuthTLSSecret(serversTransportTCP.Namespace, secret, client) if err != nil { logger.Error(). Err(err). Str(\"certificates\", secret). Msg(\"Error while loading certificates\") continue } certs = append(certs, tls.Certificate{ CertFile: types.FileOrContent(tlsCert), KeyFile: types.FileOrContent(tlsKey), }) } tcpServerTransport.TLS = \u0026dynamic.TLSClientConfig{ ServerName: serversTransportTCP.Spec.TLS.ServerName, InsecureSkipVerify: serversTransportTCP.Spec.TLS.InsecureSkipVerify, RootCAs: rootCAs, Certificates: certs, PeerCertURI: serversTransportTCP.Spec.TLS.PeerCertURI, } tcpServerTransport.TLS.Spiffe = serversTransportTCP.Spec.TLS.Spiffe } id := provider.Normalize(makeID(serversTransportTCP.Namespace, serversTransportTCP.Name)) conf.TCP.ServersTransports[id] = \u0026tcpServerTransport } } 2.4. 配置更新:\n提供商通过 configurationChan 将 Traefik 就绪的配置传输给 Watcher。Watcher 随后整合这些更新并将它们转发给 Listener 以进行应用。\n此过程确保 Traefik 动态更新其路由规则和配置，以与 Kubernetes 集群的演变状态保持一致。\n3. Switcher:\nSwitcher 的本质是 sync.Map + interface{} 的组合，其目的是以线程安全的方式获取并动态更新 handler。\npkg/safe/safe.go\n// Safe encapsulates a thread-safe value. type Safe struct { value interface{} lock sync.RWMutex } pkg/server/server_entrypoint_tcp.go\nfunc createHTTPServer(ctx context.Context, ln net.Listener, configuration *static.EntryPoint, withH2c bool, reqDecorator *requestdecorator.RequestDecorator) (*httpServer, error) { if configuration.HTTP2.MaxConcurrentStreams \u003c 0 { return nil, errors.New(\"max concurrent streams value must be greater than or equal to zero\") } httpSwitcher := middlewares.NewHandlerSwitcher(router.BuildDefaultHTTPRouter()) next, err := alice.New(requestdecorator.WrapHandler(reqDecorator)).Then(httpSwitcher) if err != nil { return nil, err } pkg/middlewares/handler_switcher.go\n// NewHandlerSwitcher builds a new instance of HTTPHandlerSwitcher. func NewHandlerSwitcher(newHandler http.Handler) (hs *HTTPHandlerSwitcher) { return \u0026HTTPHandlerSwitcher{ handler: safe.New(newHandler), } } func (h *HTTPHandlerSwitcher) ServeHTTP(rw http.ResponseWriter, req *http.Request) { handlerBackup := h.handler.Get().(http.Handler) handlerBackup.ServeHTTP(rw, req) } // GetHandler returns the current http.ServeMux. func (h *HTTPHandlerSwitcher) GetHandler() (newHandler http.Handler) { handler := h.handler.Get().(http.Handler) return handler } // UpdateHandler safely updates the current http.ServeMux with a new one.func (h *HTTPHandlerSwitcher) UpdateHandler(newHandler http.Handler) { h.handler.Set(newHandler) } 健康检查：确保可用性 Traefik 对自身和后端服务进行健康检查，以确保流量仅路由到运行中的实例。\n自我健康检查 Traefik 通过 /ping 端点实现自我健康检查。外部系统可以调用此端点以确定 Traefik 的健康状态。\n// Do try to do a healthcheck.func Do(staticConfiguration static.Configuration) (*http.Response, error) { if staticConfiguration.Ping == nil { return nil, errors.New(\"please enable `ping` to use health check\") } ep := staticConfiguration.Ping.EntryPoint if ep == \"\" { ep = \"traefik\" } pingEntryPoint, ok := staticConfiguration.EntryPoints[ep] if !ok { return nil, fmt.Errorf(\"ping: missing %s entry point\", ep) } client := \u0026http.Client{Timeout: 5 * time.Second} protocol := \"http\" path := \"/\" return client.Head(protocol + \"://\" + pingEntryPoint.GetAddress() + path + \"ping\") } 当 Traefik 运行时，此端点返回 200 OK 状态。失败的健康检查会导致非 200 状态代码，表明存在问题。\n后端服务健康检查 Traefik 支持通过 HTTP、HTTPS 和 gRPC 协议对后端服务进行健康检查。可配置的健康检查使得能够评估后端服务器的可用性。\n以下是 Traefik 如何进行后端服务健康检查的简要说明：\n配置: 在服务配置中设置健康检查细节，例如健康检查路径、间隔和超时等参数。 健康检查器 (Health Checker): 为每个启用了健康检查的服务实例化一个 ServiceHealthChecker。 定期检查: 健康检查器根据间隔设置定期向后端服务器发送请求。 状态更新: 健康检查器根据健康检查响应更新每个服务器的状态。 负载均衡器更新: 负载均衡器会收到任何状态更改的通知，并在分发请求时予以考虑。 这是 ServiceHealthChecker 的 Go 代码片段：\npkg/healthcheck/healthcheck.go\nfunc NewServiceHealthChecker(ctx context.Context, metrics metricsHealthCheck, config *dynamic.ServerHealthCheck, service StatusSetter, info *runtime.ServiceInfo, transport http.RoundTripper, targets map[string]*url.URL) *ServiceHealthChecker { logger := log.Ctx(ctx) interval := time.Duration(config.Interval) if interval \u003c= 0 { logger.Error().Msg(\"Health check interval smaller than zero\") interval = time.Duration(dynamic.DefaultHealthCheckInterval) } timeout := time.Duration(config.Timeout) if timeout \u003c= 0 { logger.Error().Msg(\"Health check timeout smaller than zero\") timeout = time.Duration(dynamic.DefaultHealthCheckTimeout) } client := \u0026http.Client{ Transport: transport, } if config.FollowRedirects != nil \u0026\u0026 !*config.FollowRedirects { client.CheckRedirect = func(req *http.Request, via []*http.Request) error { return http.ErrUseLastResponse } } return \u0026ServiceHealthChecker{ balancer: service, info: info, config: config, interval: interval, timeout: timeout, targets: targets, client: client, metrics: metrics, } } func (shc *ServiceHealthChecker) Launch(ctx context.Context) { ticker := time.NewTicker(shc.interval) defer ticker.Stop() for { select { case \u003c-ctx.Done(): return case \u003c-ticker.C: for proxyName, target := range shc.targets { select { case \u003c-ctx.Done(): return default: } up := true serverUpMetricValue := float64(1) if err := shc.executeHealthCheck(ctx, shc.config, target); err != nil { // The context is canceled when the dynamic configuration is refreshed. // 当动态配置刷新时，context 被取消。 if errors.Is(err, context.Canceled) { return } log.Ctx(ctx).Warn(). Str(\"targetURL\", target.String()). Err(err). Msg(\"Health check failed.\") up = false serverUpMetricValue = float64(0) } shc.balancer.SetStatus(ctx, proxyName, up) statusStr := runtime.StatusDown if up { statusStr = runtime.StatusUp } shc.info.UpdateServerStatus(target.String(), statusStr) shc.metrics.ServiceServerUpGauge(). With(\"service\", proxyName, \"url\", target.String()). Set(serverUpMetricValue) } } } } func (shc *ServiceHealthChecker) executeHealthCheck(ctx context.Context, config *dynamic.ServerHealthCheck, target *url.URL) error { ctx, cancel := context.WithDeadline(ctx, time.Now().Add(shc.timeout)) defer cancel() if config.Mode == modeGRPC { return shc.checkHealthGRPC(ctx, target) } return shc.checkHealthHTTP(ctx, target) } // checkHealthHTTP returns an error with a meaningful description if the health check failed. // Dedicated to HTTP servers. func (shc *ServiceHealthChecker) checkHealthHTTP(ctx context.Context, target *url.URL) error { req, err := shc.newRequest(ctx, target) if err != nil { return fmt.Errorf(\"create HTTP request: %w\", err) } resp, err := shc.client.Do(req) if err != nil { return fmt.Errorf(\"HTTP request failed: %w\", err) } defer resp.Body.Close() if shc.config.Status == 0 \u0026\u0026 (resp.StatusCode \u003c http.StatusOK || resp.StatusCode \u003e= http.StatusBadRequest) { return fmt.Errorf(\"received error status code: %v\", resp.StatusCode) } if shc.config.Status != 0 \u0026\u0026 shc.config.Status != resp.StatusCode { return fmt.Errorf(\"received error status code: %v expected status code: %v\", resp.StatusCode, shc.config.Status) } return nil } 这段代码展示了健康检查器发送健康检查请求并根据响应更新服务器状态。负载均衡器随后使用此信息将流量仅引导至响应正常的服务器。\n中间件：增强路由过程 Traefik 的中间件系统允许将附加功能注入请求/响应生命周期。中间件可以链接到路由器或服务，以执行身份验证、速率限制和请求转换等任务。\nTraefik 提供了广泛的内置中间件，并且可以通过插件集成自定义中间件。\n中间件处理管道 以下概述了 Traefik 如何处理中间件：\n配置: 中间件在动态配置中定义，并链接到路由器或服务。 中间件链: 根据配置构建中间件链，顺序决定了它们的执行顺序。 请求处理: 对进入的请求，在到达后端服务之前会遍历中间件链，允许每个中间件更改请求或生成响应。 响应处理: 后端服务响应后，响应会以相反的顺序通过中间件链回传，允许在到达客户端之前进行修改。 源码分析：中间件构建器 (Middleware Builder) middleware.Builder 负责从配置构建中间件链。它提供了一个 BuildChain 函数，该函数接受上下文和中间件名称列表，返回一个 alice.Chain 对象。\n这是 BuildChain 函数的简化版本：\npkg/server/middleware/middlewares.go\nfunc (b *Builder) BuildChain(ctx context.Context, middlewares []string) *alice.Chain { chain := alice.New() for _, name := range middlewares { middlewareName := provider.GetQualifiedName(ctx, name) chain = chain.Append(func(next http.Handler) (http.Handler, error) { constructorContext := provider.AddInContext(ctx, middlewareName) if midInf, ok := b.configs[middlewareName]; !ok || midInf.Middleware == nil { return nil, fmt.Errorf(\"middleware %q does not exist\", middlewareName) } var err error if constructorContext, err = checkRecursion(constructorContext, middlewareName); err != nil { b.configs[middlewareName].AddError(err, true) return nil, err } constructor, err := b.buildConstructor(constructorContext, middlewareName) if err != nil { b.configs[middlewareName].AddError(err, true) return nil, err } handler, err := constructor(next) if err != nil { b.configs[middlewareName].AddError(err, true) return nil, err } return handler, nil }) } return \u0026chain } func checkRecursion(ctx context.Context, middlewareName string) (context.Context, error) { currentStack, ok := ctx.Value(middlewareStackKey).([]string) if !ok { currentStack = []string{} } if inSlice(middlewareName, currentStack) { return ctx, fmt.Errorf(\"could not instantiate middleware %s: recursion detected in %s\", middlewareName, strings.Join(append(currentStack, middlewareName), \"-\u003e\")) } return context.WithValue(ctx, middlewareStackKey, append(currentStack, middlewareName)), nil } // it is the responsibility of the caller to make sure that b.configs[middlewareName].Middleware exists. func (b *Builder) buildConstructor(ctx context.Context, middlewareName string) (alice.Constructor, error) { config := b.configs[middlewareName] if config == nil || config.Middleware == nil { return nil, fmt.Errorf(\"invalid middleware %q configuration\", middlewareName) } var middleware alice.Constructor badConf := errors.New(\"cannot create middleware: multi-types middleware not supported, consider declaring two different pieces of middleware instead\") // ... // Chain if config.Chain != nil { if middleware != nil { return nil, badConf } var qualifiedNames []string for _, name := range config.Chain.Middlewares { qualifiedNames = append(qualifiedNames, provider.GetQualifiedName(ctx, name)) } config.Chain.Middlewares = qualifiedNames middleware = func(next http.Handler) (http.Handler, error) { return chain.New(ctx, next, *config.Chain, b, middlewareName) } } // ... if middleware == nil { return nil, fmt.Errorf(\"invalid middleware %q configuration: invalid middleware type or middleware does not exist\", middlewareName) } // The tracing middleware is a NOOP if tracing is not setup on the middleware chain. // Hence, regarding internal resources' observability deactivation, // this would not enable tracing. return tracing.WrapMiddleware(ctx, middleware), nil } 此函数遍历中间件名称以构建构造函数链。每个构造函数负责创建一个中间件实例，并将其与链中的下一个处理程序集成。\nbuildConstructor 函数根据其配置为特定中间件创建构造函数，应用反射来识别中间件类型并实例化相关函数。\n这种方法使 Traefik 能够支持具有不同配置的各种中间件，同时促进结构良好且模块化的代码库。\n结论 ","wordCount":"2181","inLanguage":"zh","datePublished":"2024-03-09T14:54:00+08:00","dateModified":"2024-03-09T14:54:00+08:00","author":{"@type":"Person","name":"zhoukuncheng"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhoukuncheng.github.io/zh/posts/traefik-architecture-and-source-code-analysis/"},"publisher":{"@type":"Organization","name":"zhoukuncheng's Personal Blog","logo":{"@type":"ImageObject","url":"https://zhoukuncheng.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://zhoukuncheng.github.io/zh/ accesskey=h title="zhoukuncheng's Personal Blog (Alt + H)">zhoukuncheng's Personal Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://zhoukuncheng.github.io/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://zhoukuncheng.github.io/zh/ title=首页><span>首页</span></a></li><li><a href=https://zhoukuncheng.github.io/zh/posts/ title=归档><span>归档</span></a></li><li><a href=https://zhoukuncheng.github.io/zh/tags/ title=标签><span>标签</span></a></li><li><a href=https://zhoukuncheng.github.io/zh/categories/ title=分类><span>分类</span></a></li><li><a href=https://zhoukuncheng.github.io/zh/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Traefik 架构与源码分析：深度探索</h1><div class=post-meta><span title='2024-03-09 14:54:00 +0800 +0800'>2024年3月9日</span>&nbsp;·&nbsp;<span>zhoukuncheng</span>&nbsp;|&nbsp;<span>语言:</span><ul class=i18n_list><li><a href=https://zhoukuncheng.github.io/posts/traefik-architecture-and-source-code-analysis/>En</a></li></ul></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#traefik-%e6%9e%b6%e6%9e%84%e9%ab%98%e5%b1%82%e6%a6%82%e8%bf%b0 aria-label="Traefik 架构：高层概述">Traefik 架构：高层概述</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e5%85%b3%e9%94%ae%e7%bb%84%e4%bb%b6 aria-label=源码分析：关键组件>源码分析：关键组件</a></li><li><a href=#%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5%e7%a1%ae%e4%bf%9d%e5%8f%af%e7%94%a8%e6%80%a7 aria-label=健康检查：确保可用性>健康检查：确保可用性</a><ul><li><a href=#%e8%87%aa%e6%88%91%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5 aria-label=自我健康检查>自我健康检查</a></li><li><a href=#%e5%90%8e%e7%ab%af%e6%9c%8d%e5%8a%a1%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5 aria-label=后端服务健康检查>后端服务健康检查</a></li></ul></li><li><a href=#%e4%b8%ad%e9%97%b4%e4%bb%b6%e5%a2%9e%e5%bc%ba%e8%b7%af%e7%94%b1%e8%bf%87%e7%a8%8b aria-label=中间件：增强路由过程>中间件：增强路由过程</a><ul><li><a href=#%e4%b8%ad%e9%97%b4%e4%bb%b6%e5%a4%84%e7%90%86%e7%ae%a1%e9%81%93 aria-label=中间件处理管道>中间件处理管道</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e4%b8%ad%e9%97%b4%e4%bb%b6%e6%9e%84%e5%bb%ba%e5%99%a8-middleware-builder aria-label="源码分析：中间件构建器 (Middleware Builder)">源码分析：中间件构建器 (Middleware Builder)</a></li></ul></li><li><a href=#%e7%bb%93%e8%ae%ba aria-label=结论>结论</a></li></ul></div></details></div><div class=post-content><p><img alt="Traefik Architecture Diagram" loading=lazy src=https://doc.traefik.io/traefik/assets/img/traefik-architecture.png></p><p>Traefik 是一个被广泛采用的开源 HTTP 反向代理和负载均衡器，它简化了现代 Web 应用程序的路由和请求负载均衡。它拥有动态配置功能，并支持众多提供商 (providers)，定位为编排复杂部署场景的多功能解决方案。在这篇博文中，我们将深入探讨 Traefik 的架构，并剖析其源代码的关键组件，以便更细致地了解其运行机制。</p><h3 id=traefik-架构高层概述>Traefik 架构：高层概述<a hidden class=anchor aria-hidden=true href=#traefik-架构高层概述>#</a></h3><p>在其核心，Traefik 的架构由几个主要组件组成，这些组件协同工作以促进动态路由和负载均衡：</p><ul><li><p><strong>静态配置 (Static Configuration):</strong> 这些是 Traefik 的基础设置，包括入口点 (entry points)、提供商 (providers) 和 API 访问配置。它们可以通过文件、命令行参数或环境变量来指定。</p></li><li><p><strong>动态配置 (Dynamic Configuration):</strong> 这涉及可根据基础设施状态进行调整的路由规则、服务和中间件。Traefik 与多种提供商（如 Docker、Kubernetes、Consul Catalog 等）的兼容性突显了其动态特性。</p></li><li><p><strong>提供商 (Providers):</strong> 作为 Traefik 与服务发现机制之间的桥梁，提供商的任务是获取并将动态配置传递给 Traefik。每个提供商都是为集成不同技术（如 Docker、Kubernetes 和 Consul）而定制的。</p></li><li><p><strong>入口点 (Entry Points):</strong> 这些指定了 Traefik 监听入站流量的网络接口（端口和协议）。</p></li><li><p><strong>路由器 (Routers):</strong> 路由器建立通过各种参数（如主机名、路径和头部）匹配传入请求的标准。它们负责将请求引导至适当的服务。</p></li><li><p><strong>服务 (Services):</strong> 服务定义了 Traefik 与处理请求的后端系统进行通信的机制。可以通过不同的负载均衡策略和健康检查对服务进行微调。</p></li><li><p><strong>中间件 (Middlewares):</strong> 作为模块化实体，中间件可以附加到路由器或服务上，启用一系列功能，包括身份验证、速率限制和请求修改。</p></li><li><p><strong>插件 (Plugins):</strong> Traefik 可以通过插件进行扩展，从而增强其功能。插件系统允许开发人员贡献自定义插件。</p></li></ul><p>这些组件的编排如下：</p><ol><li>Traefik 摄取静态配置并开始监控指定的入口点。</li><li>提供商持续扫描基础设施以查找配置更改，并通过动态配置通道将其转发给 Traefik。</li><li>Traefik 处理动态配置，更新其内部结构——路由器、服务和中间件——以反映这些更改。</li><li>当请求进入时，Traefik 根据路由器规则对其进行匹配，并将其引导至指定的服务。</li><li>服务应用其负载均衡逻辑将请求分发到后端服务器。</li><li>中间件可以在请求/响应生命周期的各个阶段被调用，以执行其各自的职责。</li></ol><p>这种动态架构使 Traefik 能够敏捷地适应基础设施内的变化，自动调整路由配置以与已部署的服务保持一致。</p><h3 id=源码分析关键组件>源码分析：关键组件<a hidden class=anchor aria-hidden=true href=#源码分析关键组件>#</a></h3><p>现在，让我们检查 Traefik 源代码中的一些关键组件：</p><p><img loading=lazy src=https://xiaorui.cc/wp-content/uploads/2022/11/Jietu20221123-124659.jpg></p><p><strong>1. Watcher 和 Listener:</strong></p><p>Watcher 和 Listener 协作以检测和执行动态配置更改。Watcher 负责不断调查配置源并将更新推送到 Listener。随后，Listener 验证这些更新并将它们与 Traefik 的内部状态集成。</p><p><strong>Watcher:</strong><br><code>pkg/server/configurationwatcher.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewConfigurationWatcher creates a new ConfigurationWatcher.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewConfigurationWatcher</span><span class=p>(</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>routinesPool</span><span class=w> </span><span class=o>*</span><span class=nx>safe</span><span class=p>.</span><span class=nx>Pool</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>pvd</span><span class=w> </span><span class=nx>provider</span><span class=p>.</span><span class=nx>Provider</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>defaultEntryPoints</span><span class=w> </span><span class=p>[]</span><span class=kt>string</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>requiredProvider</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>ConfigurationWatcher</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>providerAggregator</span><span class=p>:</span><span class=w>  </span><span class=nx>pvd</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>allProvidersConfigs</span><span class=p>:</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>newConfigs</span><span class=p>:</span><span class=w>          </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configurations</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>routinesPool</span><span class=p>:</span><span class=w>        </span><span class=nx>routinesPool</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>defaultEntryPoints</span><span class=p>:</span><span class=w>  </span><span class=nx>defaultEntryPoints</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>requiredProvider</span><span class=p>:</span><span class=w>    </span><span class=nx>requiredProvider</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=c1>// Start the configuration watcher.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=p>)</span><span class=w> </span><span class=nf>Start</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>c</span><span class=p>.</span><span class=nx>routinesPool</span><span class=p>.</span><span class=nf>GoCtx</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>receiveConfigurations</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>c</span><span class=p>.</span><span class=nx>routinesPool</span><span class=p>.</span><span class=nf>GoCtx</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>applyConfigurations</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>c</span><span class=p>.</span><span class=nf>startProviderAggregator</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=c1>// Stop the configuration watcher.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=p>)</span><span class=w> </span><span class=nf>Stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nb>close</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>allProvidersConfigs</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nb>close</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>newConfigs</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=c1>// AddListener adds a new listener function used when new configuration is provided.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=p>)</span><span class=w> </span><span class=nf>AddListener</span><span class=p>(</span><span class=nx>listener</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>configurationListeners</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>c</span><span class=p>.</span><span class=nx>configurationListeners</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kd>func</span><span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>c</span><span class=p>.</span><span class=nx>configurationListeners</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>configurationListeners</span><span class=p>,</span><span class=w> </span><span class=nx>listener</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>ConfigurationWatcher</span><span class=p>)</span><span class=w> </span><span class=nf>startProviderAggregator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Starting provider aggregator %T&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>providerAggregator</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>safe</span><span class=p>.</span><span class=nf>Go</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>providerAggregator</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>allProvidersConfigs</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>routinesPool</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Error starting provider aggregator %T&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>providerAggregator</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>})</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>Listener:</strong><br><code>cmd/traefik/traefik.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Server Transports  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>watcher</span><span class=p>.</span><span class=nf>AddListener</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>conf</span><span class=w> </span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>roundTripperManager</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>HTTP</span><span class=p>.</span><span class=nx>ServersTransports</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>dialerManager</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>conf</span><span class=p>.</span><span class=nx>TCP</span><span class=p>.</span><span class=nx>ServersTransports</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>})</span><span class=w>
</span></span></span></code></pre></div><p><code>pkg/server/service/roundtripper.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// RoundTripperManager handles roundtripper for the reverse proxy.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>RoundTripperManager</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>rtLock</span><span class=w>        </span><span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>roundTrippers</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>http</span><span class=p>.</span><span class=nx>RoundTripper</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>configs</span><span class=w>       </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServersTransport</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>spiffeX509Source</span><span class=w> </span><span class=nx>SpiffeX509Source</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=c1>// Update updates the roundtrippers configurations.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>RoundTripperManager</span><span class=p>)</span><span class=w> </span><span class=nf>Update</span><span class=p>(</span><span class=nx>newConfigs</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServersTransport</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>r</span><span class=p>.</span><span class=nx>rtLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>defer</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>rtLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=nx>configName</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>configs</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>newConfig</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>newConfigs</span><span class=p>[</span><span class=nx>configName</span><span class=p>]</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nb>delete</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>configs</span><span class=p>,</span><span class=w> </span><span class=nx>configName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nb>delete</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>,</span><span class=w> </span><span class=nx>configName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>continue</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>reflect</span><span class=p>.</span><span class=nf>DeepEqual</span><span class=p>(</span><span class=nx>newConfig</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>continue</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>[</span><span class=nx>configName</span><span class=p>],</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nf>createRoundTripper</span><span class=p>(</span><span class=nx>newConfig</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Could not configure HTTP Transport %s, fallback on default transport&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>configName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>[</span><span class=nx>configName</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>DefaultTransport</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=nx>newConfigName</span><span class=p>,</span><span class=w> </span><span class=nx>newConfig</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>newConfigs</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>newConfigName</span><span class=p>];</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>continue</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>[</span><span class=nx>newConfigName</span><span class=p>],</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nf>createRoundTripper</span><span class=p>(</span><span class=nx>newConfig</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>log</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Could not configure HTTP Transport %s, fallback on default transport&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>newConfigName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>r</span><span class=p>.</span><span class=nx>roundTrippers</span><span class=p>[</span><span class=nx>newConfigName</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>DefaultTransport</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>r</span><span class=p>.</span><span class=nx>configs</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>newConfigs</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>2. Provider:</strong></p><p>Provider 在 Traefik 的架构中至关重要，它与特定技术接口以发掘并传递配置更新。<code>Provide</code> 函数位于 Provider 角色的核心，管理连接、发现和更新过程。</p><p><strong>Kubernetes Provider: 配置发现</strong></p><p>Traefik 中的 Kubernetes 提供商从 Kubernetes API 服务器中提取配置详细信息，监控 Kubernetes 资源（如 Ingress、IngressRoute、Service 和 Middleware 对象）的变化。</p><p><strong>2.1. Kubernetes 客户端初始化:</strong></p><p>提供商初始化一个客户端以连接到 Kubernetes API，利用此客户端与 API 交互并观察资源变化。</p><p><code>pkg/provider/kubernetes/crd/kubernetes.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=o>*</span><span class=nx>Provider</span><span class=p>)</span><span class=w> </span><span class=nf>newK8sClient</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>clientWrapper</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>labels</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid label selector: %q&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;label selector is: %q&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>withEndpoint</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>Endpoint</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>withEndpoint</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34; with endpoint %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>var</span><span class=w> </span><span class=nx>client</span><span class=w> </span><span class=o>*</span><span class=nx>clientWrapper</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>switch</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>case</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBERNETES_SERVICE_HOST&#34;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBERNETES_SERVICE_PORT&#34;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Creating in-cluster Provider client%s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>withEndpoint</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>client</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>newInClusterClient</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>case</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBECONFIG&#34;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Creating cluster-external Provider client from KUBECONFIG %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBECONFIG&#34;</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>client</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>newExternalClusterClientFromFile</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;KUBECONFIG&#34;</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>default</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Creating cluster-external Provider client%s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>withEndpoint</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>client</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>newExternalClusterClient</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>,</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>CertAuthFilePath</span><span class=p>,</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>Token</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>client</span><span class=p>.</span><span class=nx>labelSelector</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=nx>client</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>2.2. 资源监控 (Resource Watching):</strong></p><p>提供商使用 Kubernetes 客户端来观察相关资源的变化。通常使用 Informers 来有效地跟踪这些资源，并在创建、更新或删除时接收通知。</p><p><code>pkg/provider/kubernetes/crd/kubernetes.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Provide allows the k8s provider to provide configurations to traefik// using the given configuration channel.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=o>*</span><span class=nx>Provider</span><span class=p>)</span><span class=w> </span><span class=nf>Provide</span><span class=p>(</span><span class=nx>configurationChan</span><span class=w> </span><span class=kd>chan</span><span class=o>&lt;-</span><span class=w> </span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Message</span><span class=p>,</span><span class=w> </span><span class=nx>pool</span><span class=w> </span><span class=o>*</span><span class=nx>safe</span><span class=p>.</span><span class=nx>Pool</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>logger</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>log</span><span class=p>.</span><span class=nf>With</span><span class=p>().</span><span class=nf>Str</span><span class=p>(</span><span class=nx>logs</span><span class=p>.</span><span class=nx>ProviderName</span><span class=p>,</span><span class=w> </span><span class=nx>providerName</span><span class=p>).</span><span class=nf>Logger</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>ctxLog</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>logger</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>k8sClient</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nf>newK8sClient</span><span class=p>(</span><span class=nx>ctxLog</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>AllowCrossNamespace</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Warn</span><span class=p>().</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Cross-namespace reference between IngressRoutes and resources is enabled, please ensure that this is expected (see AllowCrossNamespace option)&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>AllowExternalNameServices</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Warn</span><span class=p>().</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;ExternalName service loading is enabled, please ensure that this is expected (see AllowExternalNameServices option)&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>pool</span><span class=p>.</span><span class=nf>GoCtx</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>ctxPool</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>operation</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>eventsChan</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>k8sClient</span><span class=p>.</span><span class=nf>WatchAll</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Namespaces</span><span class=p>,</span><span class=w> </span><span class=nx>ctxPool</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Error watching kubernetes events&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>timer</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>timer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctxPool</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>throttleDuration</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>ThrottleDuration</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>throttledChan</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>throttleEvents</span><span class=p>(</span><span class=nx>ctxLog</span><span class=p>,</span><span class=w> </span><span class=nx>throttleDuration</span><span class=p>,</span><span class=w> </span><span class=nx>pool</span><span class=p>,</span><span class=w> </span><span class=nx>eventsChan</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>if</span><span class=w> </span><span class=nx>throttledChan</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>eventsChan</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>throttledChan</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctxPool</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>eventsChan</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>// Note that event is the *first* event that came in during this throttling interval -- if we&#39;re hitting our throttle, we may have dropped events.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>// This is fine, because we don&#39;t treat different event types differently.               </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>// But if we do in the future, we&#39;ll need to track more information about the dropped events.               </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>conf</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nf>loadConfigurationFromCRD</span><span class=p>(</span><span class=nx>ctxLog</span><span class=p>,</span><span class=w> </span><span class=nx>k8sClient</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>confHash</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>hashstructure</span><span class=p>.</span><span class=nf>Hash</span><span class=p>(</span><span class=nx>conf</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>switch</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>case</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Unable to hash the configuration&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>case</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>lastConfiguration</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>confHash</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Debug</span><span class=p>().</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Skipping Kubernetes event kind %T&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>default</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nx>p</span><span class=p>.</span><span class=nx>lastConfiguration</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>confHash</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nx>configurationChan</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Message</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=nx>ProviderName</span><span class=p>:</span><span class=w>  </span><span class=nx>providerName</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=nx>Configuration</span><span class=p>:</span><span class=w> </span><span class=nx>conf</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>// If we&#39;re throttling,  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>// we sleep here for the throttle duration to enforce that we don&#39;t refresh faster than our throttle.               </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>// time.Sleep returns immediately if p.ThrottleDuration is 0 (no throttle).               </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>throttleDuration</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>notify</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msgf</span><span class=p>(</span><span class=s>&#34;Provider error, retrying in %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>backoff</span><span class=p>.</span><span class=nf>RetryNotify</span><span class=p>(</span><span class=nx>safe</span><span class=p>.</span><span class=nf>OperationWithRecover</span><span class=p>(</span><span class=nx>operation</span><span class=p>),</span><span class=w> </span><span class=nx>backoff</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>job</span><span class=p>.</span><span class=nf>NewBackOff</span><span class=p>(</span><span class=nx>backoff</span><span class=p>.</span><span class=nf>NewExponentialBackOff</span><span class=p>()),</span><span class=w> </span><span class=nx>ctxPool</span><span class=p>),</span><span class=w> </span><span class=nx>notify</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Cannot retrieve data&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>})</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>2.3. 配置解析 (Configuration Parsing):</strong></p><p>接收到资源更新后，提供商会解析数据以提取配置详细信息。然后，这些配置被转换为 Traefik 特定的格式，用于路由器、服务和中间件。</p><p><code>pkg/provider/kubernetes/crd/kubernetes.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=o>*</span><span class=nx>Provider</span><span class=p>)</span><span class=w> </span><span class=nf>loadConfigurationFromCRD</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>client</span><span class=w> </span><span class=nx>Client</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>conf</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Configuration</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// TODO: choose between mutating and returning tlsConfigs  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>HTTP</span><span class=p>:</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nf>loadIngressRouteConfiguration</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>client</span><span class=p>,</span><span class=w> </span><span class=nx>tlsConfigs</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>TCP</span><span class=p>:</span><span class=w>  </span><span class=nx>p</span><span class=p>.</span><span class=nf>loadIngressRouteTCPConfiguration</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>client</span><span class=p>,</span><span class=w> </span><span class=nx>tlsConfigs</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>UDP</span><span class=p>:</span><span class=w>  </span><span class=nx>p</span><span class=p>.</span><span class=nf>loadIngressRouteUDPConfiguration</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>client</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>TLS</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>TLSConfiguration</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Options</span><span class=p>:</span><span class=w> </span><span class=nf>buildTLSOptions</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>client</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Stores</span><span class=p>:</span><span class=w>  </span><span class=nx>stores</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>},</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=cp>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>conf</span><span class=p>.</span><span class=nx>HTTP</span><span class=p>.</span><span class=nx>Middlewares</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>Middleware</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>AddPrefix</span><span class=p>:</span><span class=w>         </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>AddPrefix</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>StripPrefix</span><span class=p>:</span><span class=w>       </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>StripPrefix</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>StripPrefixRegex</span><span class=p>:</span><span class=w>  </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>StripPrefixRegex</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>ReplacePath</span><span class=p>:</span><span class=w>       </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ReplacePath</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>ReplacePathRegex</span><span class=p>:</span><span class=w>  </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ReplacePathRegex</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Chain</span><span class=p>:</span><span class=w>             </span><span class=nf>createChainMiddleware</span><span class=p>(</span><span class=nx>ctxMid</span><span class=p>,</span><span class=w> </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span><span class=w> </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Chain</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>IPWhiteList</span><span class=p>:</span><span class=w>       </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>IPWhiteList</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>IPAllowList</span><span class=p>:</span><span class=w>       </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>IPAllowList</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Headers</span><span class=p>:</span><span class=w>           </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Headers</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Errors</span><span class=p>:</span><span class=w>            </span><span class=nx>errorPage</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>RateLimit</span><span class=p>:</span><span class=w>         </span><span class=nx>rateLimit</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>RedirectRegex</span><span class=p>:</span><span class=w>     </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>RedirectRegex</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>RedirectScheme</span><span class=p>:</span><span class=w>    </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>RedirectScheme</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>BasicAuth</span><span class=p>:</span><span class=w>         </span><span class=nx>basicAuth</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>DigestAuth</span><span class=p>:</span><span class=w>        </span><span class=nx>digestAuth</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>ForwardAuth</span><span class=p>:</span><span class=w>       </span><span class=nx>forwardAuth</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>InFlightReq</span><span class=p>:</span><span class=w>       </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>InFlightReq</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Buffering</span><span class=p>:</span><span class=w>         </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Buffering</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>CircuitBreaker</span><span class=p>:</span><span class=w>    </span><span class=nx>circuitBreaker</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Compress</span><span class=p>:</span><span class=w>          </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Compress</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>PassTLSClientCert</span><span class=p>:</span><span class=w> </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>PassTLSClientCert</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Retry</span><span class=p>:</span><span class=w>             </span><span class=nx>retry</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>ContentType</span><span class=p>:</span><span class=w>       </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ContentType</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>GrpcWeb</span><span class=p>:</span><span class=w>           </span><span class=nx>middleware</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>GrpcWeb</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Plugin</span><span class=p>:</span><span class=w>            </span><span class=nx>plugin</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=cp>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>cb</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>configBuilder</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>client</span><span class=p>:</span><span class=w>                    </span><span class=nx>client</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>allowCrossNamespace</span><span class=p>:</span><span class=w>       </span><span class=nx>p</span><span class=p>.</span><span class=nx>AllowCrossNamespace</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>allowExternalNameServices</span><span class=p>:</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>AllowExternalNameServices</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>allowEmptyServices</span><span class=p>:</span><span class=w>        </span><span class=nx>p</span><span class=p>.</span><span class=nx>AllowEmptyServices</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>service</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nf>GetTraefikServices</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cb</span><span class=p>.</span><span class=nf>buildTraefikService</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>service</span><span class=p>,</span><span class=w> </span><span class=nx>conf</span><span class=p>.</span><span class=nx>HTTP</span><span class=p>.</span><span class=nx>Services</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Str</span><span class=p>(</span><span class=nx>logs</span><span class=p>.</span><span class=nx>ServiceName</span><span class=p>,</span><span class=w> </span><span class=nx>service</span><span class=p>.</span><span class=nx>Name</span><span class=p>).</span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Error while building TraefikService&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>continue</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=cp>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>id</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>provider</span><span class=p>.</span><span class=nf>Normalize</span><span class=p>(</span><span class=nf>makeID</span><span class=p>(</span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span><span class=w> </span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Name</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>conf</span><span class=p>.</span><span class=nx>HTTP</span><span class=p>.</span><span class=nx>ServersTransports</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServersTransport</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>ServerName</span><span class=p>:</span><span class=w>          </span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ServerName</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>InsecureSkipVerify</span><span class=p>:</span><span class=w>  </span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>InsecureSkipVerify</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>RootCAs</span><span class=p>:</span><span class=w>             </span><span class=nx>rootCAs</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Certificates</span><span class=p>:</span><span class=w>        </span><span class=nx>certs</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>DisableHTTP2</span><span class=p>:</span><span class=w>        </span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>DisableHTTP2</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>MaxIdleConnsPerHost</span><span class=p>:</span><span class=w> </span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxIdleConnsPerHost</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>ForwardingTimeouts</span><span class=p>:</span><span class=w>  </span><span class=nx>forwardingTimeout</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>PeerCertURI</span><span class=p>:</span><span class=w>         </span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>PeerCertURI</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>Spiffe</span><span class=p>:</span><span class=w>              </span><span class=nx>serversTransport</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Spiffe</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nf>GetServersTransportTCPs</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>tcpServerTransport</span><span class=w> </span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>TCPServersTransport</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>tcpServerTransport</span><span class=p>.</span><span class=nf>SetDefaults</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>DialTimeout</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>DialKeepAlive</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TerminationDelay</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=kd>var</span><span class=w> </span><span class=nx>rootCAs</span><span class=w> </span><span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>FileOrContent</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>secret</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>RootCAsSecrets</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>caSecret</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>loadCASecret</span><span class=p>(</span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span><span class=w> </span><span class=nx>secret</span><span class=p>,</span><span class=w> </span><span class=nx>client</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Str</span><span class=p>(</span><span class=s>&#34;rootCAs&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>secret</span><span class=p>).</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Error while loading rootCAs&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>continue</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>rootCAs</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>rootCAs</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nf>FileOrContent</span><span class=p>(</span><span class=nx>caSecret</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=kd>var</span><span class=w> </span><span class=nx>certs</span><span class=w> </span><span class=nx>tls</span><span class=p>.</span><span class=nx>Certificates</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>secret</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>CertificatesSecrets</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>tlsCert</span><span class=p>,</span><span class=w> </span><span class=nx>tlsKey</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>loadAuthTLSSecret</span><span class=p>(</span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span><span class=w> </span><span class=nx>secret</span><span class=p>,</span><span class=w> </span><span class=nx>client</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Str</span><span class=p>(</span><span class=s>&#34;certificates&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>secret</span><span class=p>).</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Error while loading certificates&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>continue</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>certs</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>certs</span><span class=p>,</span><span class=w> </span><span class=nx>tls</span><span class=p>.</span><span class=nx>Certificate</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>CertFile</span><span class=p>:</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nf>FileOrContent</span><span class=p>(</span><span class=nx>tlsCert</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>KeyFile</span><span class=p>:</span><span class=w>  </span><span class=nx>types</span><span class=p>.</span><span class=nf>FileOrContent</span><span class=p>(</span><span class=nx>tlsKey</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>})</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>tcpServerTransport</span><span class=p>.</span><span class=nx>TLS</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>TLSClientConfig</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>ServerName</span><span class=p>:</span><span class=w>         </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>ServerName</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>InsecureSkipVerify</span><span class=p>:</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>InsecureSkipVerify</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>RootCAs</span><span class=p>:</span><span class=w>            </span><span class=nx>rootCAs</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Certificates</span><span class=p>:</span><span class=w>       </span><span class=nx>certs</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>PeerCertURI</span><span class=p>:</span><span class=w>        </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>PeerCertURI</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>tcpServerTransport</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>Spiffe</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TLS</span><span class=p>.</span><span class=nx>Spiffe</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>id</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>provider</span><span class=p>.</span><span class=nf>Normalize</span><span class=p>(</span><span class=nf>makeID</span><span class=p>(</span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span><span class=w> </span><span class=nx>serversTransportTCP</span><span class=p>.</span><span class=nx>Name</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>conf</span><span class=p>.</span><span class=nx>TCP</span><span class=p>.</span><span class=nx>ServersTransports</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>tcpServerTransport</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>2.4. 配置更新:</strong></p><p>提供商通过 <code>configurationChan</code> 将 Traefik 就绪的配置传输给 Watcher。Watcher 随后整合这些更新并将它们转发给 Listener 以进行应用。</p><p>此过程确保 Traefik 动态更新其路由规则和配置，以与 Kubernetes 集群的演变状态保持一致。</p><p><strong>3. Switcher:</strong></p><p>Switcher 的本质是 sync.Map + interface{} 的组合，其目的是以线程安全的方式获取并动态更新 handler。</p><p><code>pkg/safe/safe.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Safe encapsulates a thread-safe value.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Safe</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>value</span><span class=w> </span><span class=kd>interface</span><span class=p>{}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>lock</span><span class=w>  </span><span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>pkg/server/server_entrypoint_tcp.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>createHTTPServer</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>ln</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nx>Listener</span><span class=p>,</span><span class=w> </span><span class=nx>configuration</span><span class=w> </span><span class=o>*</span><span class=nx>static</span><span class=p>.</span><span class=nx>EntryPoint</span><span class=p>,</span><span class=w> </span><span class=nx>withH2c</span><span class=w> </span><span class=kt>bool</span><span class=p>,</span><span class=w> </span><span class=nx>reqDecorator</span><span class=w> </span><span class=o>*</span><span class=nx>requestdecorator</span><span class=p>.</span><span class=nx>RequestDecorator</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>httpServer</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>configuration</span><span class=p>.</span><span class=nx>HTTP2</span><span class=p>.</span><span class=nx>MaxConcurrentStreams</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;max concurrent streams value must be greater than or equal to zero&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>httpSwitcher</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>middlewares</span><span class=p>.</span><span class=nf>NewHandlerSwitcher</span><span class=p>(</span><span class=nx>router</span><span class=p>.</span><span class=nf>BuildDefaultHTTPRouter</span><span class=p>())</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>next</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>requestdecorator</span><span class=p>.</span><span class=nf>WrapHandler</span><span class=p>(</span><span class=nx>reqDecorator</span><span class=p>)).</span><span class=nf>Then</span><span class=p>(</span><span class=nx>httpSwitcher</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>pkg/middlewares/handler_switcher.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewHandlerSwitcher builds a new instance of HTTPHandlerSwitcher.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewHandlerSwitcher</span><span class=p>(</span><span class=nx>newHandler</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>hs</span><span class=w> </span><span class=o>*</span><span class=nx>HTTPHandlerSwitcher</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>HTTPHandlerSwitcher</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>handler</span><span class=p>:</span><span class=w> </span><span class=nx>safe</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>newHandler</span><span class=p>),</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=o>*</span><span class=nx>HTTPHandlerSwitcher</span><span class=p>)</span><span class=w> </span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>rw</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>handlerBackup</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>Get</span><span class=p>().(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>handlerBackup</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>rw</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=c1>// GetHandler returns the current http.ServeMux.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=o>*</span><span class=nx>HTTPHandlerSwitcher</span><span class=p>)</span><span class=w> </span><span class=nf>GetHandler</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>newHandler</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>handler</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>Get</span><span class=p>().(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=nx>handler</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=c1>// UpdateHandler safely updates the current http.ServeMux with a new one.func (h *HTTPHandlerSwitcher) UpdateHandler(newHandler http.Handler) {  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>h</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>newHandler</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=健康检查确保可用性>健康检查：确保可用性<a hidden class=anchor aria-hidden=true href=#健康检查确保可用性>#</a></h3><p>Traefik 对自身和后端服务进行健康检查，以确保流量仅路由到运行中的实例。</p><h4 id=自我健康检查>自我健康检查<a hidden class=anchor aria-hidden=true href=#自我健康检查>#</a></h4><p>Traefik 通过 <code>/ping</code> 端点实现自我健康检查。外部系统可以调用此端点以确定 Traefik 的健康状态。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Do try to do a healthcheck.func Do(staticConfiguration static.Configuration) (*http.Response, error) {  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>staticConfiguration</span><span class=p>.</span><span class=nx>Ping</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;please enable `ping` to use health check&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>ep</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>staticConfiguration</span><span class=p>.</span><span class=nx>Ping</span><span class=p>.</span><span class=nx>EntryPoint</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>ep</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&#34;traefik&#34;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>pingEntryPoint</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>staticConfiguration</span><span class=p>.</span><span class=nx>EntryPoints</span><span class=p>[</span><span class=nx>ep</span><span class=p>]</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ping: missing %s entry point&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>client</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{</span><span class=nx>Timeout</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>protocol</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>&#34;http&#34;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>path</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nf>Head</span><span class=p>(</span><span class=nx>protocol</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;://&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>pingEntryPoint</span><span class=p>.</span><span class=nf>GetAddress</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>path</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;ping&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>当 Traefik 运行时，此端点返回 200 OK 状态。失败的健康检查会导致非 200 状态代码，表明存在问题。</p><h4 id=后端服务健康检查>后端服务健康检查<a hidden class=anchor aria-hidden=true href=#后端服务健康检查>#</a></h4><p>Traefik 支持通过 HTTP、HTTPS 和 gRPC 协议对后端服务进行健康检查。可配置的健康检查使得能够评估后端服务器的可用性。</p><p>以下是 Traefik 如何进行后端服务健康检查的简要说明：</p><ol><li><strong>配置:</strong> 在服务配置中设置健康检查细节，例如健康检查路径、间隔和超时等参数。</li><li><strong>健康检查器 (Health Checker):</strong> 为每个启用了健康检查的服务实例化一个 ServiceHealthChecker。</li><li><strong>定期检查:</strong> 健康检查器根据间隔设置定期向后端服务器发送请求。</li><li><strong>状态更新:</strong> 健康检查器根据健康检查响应更新每个服务器的状态。</li><li><strong>负载均衡器更新:</strong> 负载均衡器会收到任何状态更改的通知，并在分发请求时予以考虑。</li></ol><p>这是 ServiceHealthChecker 的 Go 代码片段：<br><code>pkg/healthcheck/healthcheck.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewServiceHealthChecker</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>metrics</span><span class=w> </span><span class=nx>metricsHealthCheck</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=w> </span><span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServerHealthCheck</span><span class=p>,</span><span class=w> </span><span class=nx>service</span><span class=w> </span><span class=nx>StatusSetter</span><span class=p>,</span><span class=w> </span><span class=nx>info</span><span class=w> </span><span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>ServiceInfo</span><span class=p>,</span><span class=w> </span><span class=nx>transport</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>RoundTripper</span><span class=p>,</span><span class=w> </span><span class=nx>targets</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>ServiceHealthChecker</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>logger</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>interval</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Interval</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>interval</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Health check interval smaller than zero&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>interval</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>DefaultHealthCheckInterval</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>timeout</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Timeout</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>timeout</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>().</span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Health check timeout smaller than zero&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>timeout</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>DefaultHealthCheckTimeout</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>client</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>Transport</span><span class=p>:</span><span class=w> </span><span class=nx>transport</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>FollowRedirects</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>!</span><span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>FollowRedirects</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>client</span><span class=p>.</span><span class=nx>CheckRedirect</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>req</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span><span class=w> </span><span class=nx>via</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>ErrUseLastResponse</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>ServiceHealthChecker</span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>balancer</span><span class=p>:</span><span class=w> </span><span class=nx>service</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>info</span><span class=p>:</span><span class=w>     </span><span class=nx>info</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>config</span><span class=p>:</span><span class=w>   </span><span class=nx>config</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>interval</span><span class=p>:</span><span class=w> </span><span class=nx>interval</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>timeout</span><span class=p>:</span><span class=w>  </span><span class=nx>timeout</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>targets</span><span class=p>:</span><span class=w>  </span><span class=nx>targets</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>client</span><span class=p>:</span><span class=w>   </span><span class=nx>client</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>metrics</span><span class=p>:</span><span class=w>  </span><span class=nx>metrics</span><span class=p>,</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>shc</span><span class=w> </span><span class=o>*</span><span class=nx>ServiceHealthChecker</span><span class=p>)</span><span class=w> </span><span class=nf>Launch</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>ticker</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>NewTicker</span><span class=p>(</span><span class=nx>shc</span><span class=p>.</span><span class=nx>interval</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>defer</span><span class=w> </span><span class=nx>ticker</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ticker</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>for</span><span class=w> </span><span class=nx>proxyName</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nx>targets</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>return</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>up</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kc>true</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>serverUpMetricValue</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nf>executeHealthCheck</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>// The context is canceled when the dynamic configuration is refreshed.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>// 当动态配置刷新时，context 被取消。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>if</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Canceled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=k>return</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>log</span><span class=p>.</span><span class=nf>Ctx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Warn</span><span class=p>().</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Str</span><span class=p>(</span><span class=s>&#34;targetURL&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=p>.</span><span class=nf>String</span><span class=p>()).</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Err</span><span class=p>(</span><span class=nx>err</span><span class=p>).</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nf>Msg</span><span class=p>(</span><span class=s>&#34;Health check failed.&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>up</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>serverUpMetricValue</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>shc</span><span class=p>.</span><span class=nx>balancer</span><span class=p>.</span><span class=nf>SetStatus</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>proxyName</span><span class=p>,</span><span class=w> </span><span class=nx>up</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>statusStr</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>runtime</span><span class=p>.</span><span class=nx>StatusDown</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>up</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nx>statusStr</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>runtime</span><span class=p>.</span><span class=nx>StatusUp</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>shc</span><span class=p>.</span><span class=nx>info</span><span class=p>.</span><span class=nf>UpdateServerStatus</span><span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span><span class=w> </span><span class=nx>statusStr</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>shc</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>ServiceServerUpGauge</span><span class=p>().</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nf>With</span><span class=p>(</span><span class=s>&#34;service&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>proxyName</span><span class=p>,</span><span class=w> </span><span class=s>&#34;url&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=p>.</span><span class=nf>String</span><span class=p>()).</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=nf>Set</span><span class=p>(</span><span class=nx>serverUpMetricValue</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>shc</span><span class=w> </span><span class=o>*</span><span class=nx>ServiceHealthChecker</span><span class=p>)</span><span class=w> </span><span class=nf>executeHealthCheck</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=w> </span><span class=o>*</span><span class=nx>dynamic</span><span class=p>.</span><span class=nx>ServerHealthCheck</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=w> </span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithDeadline</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>shc</span><span class=p>.</span><span class=nx>timeout</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>defer</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>Mode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>modeGRPC</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nf>checkHealthGRPC</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nf>checkHealthHTTP</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=c1>// checkHealthHTTP returns an error with a meaningful description if the health check failed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Dedicated to HTTP servers.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>shc</span><span class=w> </span><span class=o>*</span><span class=nx>ServiceHealthChecker</span><span class=p>)</span><span class=w> </span><span class=nf>checkHealthHTTP</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=w> </span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nf>newRequest</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;create HTTP request: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>resp</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;HTTP request failed: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>defer</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;received error status code: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;received error status code: %v expected status code: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>,</span><span class=w> </span><span class=nx>shc</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这段代码展示了健康检查器发送健康检查请求并根据响应更新服务器状态。负载均衡器随后使用此信息将流量仅引导至响应正常的服务器。</p><h3 id=中间件增强路由过程>中间件：增强路由过程<a hidden class=anchor aria-hidden=true href=#中间件增强路由过程>#</a></h3><p>Traefik 的中间件系统允许将附加功能注入请求/响应生命周期。中间件可以链接到路由器或服务，以执行身份验证、速率限制和请求转换等任务。</p><p>Traefik 提供了广泛的内置中间件，并且可以通过插件集成自定义中间件。</p><h4 id=中间件处理管道>中间件处理管道<a hidden class=anchor aria-hidden=true href=#中间件处理管道>#</a></h4><p>以下概述了 Traefik 如何处理中间件：</p><ol><li><strong>配置:</strong> 中间件在动态配置中定义，并链接到路由器或服务。</li><li><strong>中间件链:</strong> 根据配置构建中间件链，顺序决定了它们的执行顺序。</li><li><strong>请求处理:</strong> 对进入的请求，在到达后端服务之前会遍历中间件链，允许每个中间件更改请求或生成响应。</li><li><strong>响应处理:</strong> 后端服务响应后，响应会以相反的顺序通过中间件链回传，允许在到达客户端之前进行修改。</li></ol><h4 id=源码分析中间件构建器-middleware-builder>源码分析：中间件构建器 (Middleware Builder)<a hidden class=anchor aria-hidden=true href=#源码分析中间件构建器-middleware-builder>#</a></h4><p>middleware.Builder 负责从配置构建中间件链。它提供了一个 BuildChain 函数，该函数接受上下文和中间件名称列表，返回一个 alice.Chain 对象。</p><p>这是 BuildChain 函数的简化版本：</p><p><code>pkg/server/middleware/middlewares.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>b</span><span class=w> </span><span class=o>*</span><span class=nx>Builder</span><span class=p>)</span><span class=w> </span><span class=nf>BuildChain</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>middlewares</span><span class=w> </span><span class=p>[]</span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>alice</span><span class=p>.</span><span class=nx>Chain</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>chain</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>name</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>middlewares</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>middlewareName</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>provider</span><span class=p>.</span><span class=nf>GetQualifiedName</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>name</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>chain</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>chain</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>next</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>constructorContext</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>provider</span><span class=p>.</span><span class=nf>AddInContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>if</span><span class=w> </span><span class=nx>midInf</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>];</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>midInf</span><span class=p>.</span><span class=nx>Middleware</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;middleware %q does not exist&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=kd>var</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>if</span><span class=w> </span><span class=nx>constructorContext</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>checkRecursion</span><span class=p>(</span><span class=nx>constructorContext</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>].</span><span class=nf>AddError</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>constructor</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>b</span><span class=p>.</span><span class=nf>buildConstructor</span><span class=p>(</span><span class=nx>constructorContext</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>].</span><span class=nf>AddError</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>handler</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>constructor</span><span class=p>(</span><span class=nx>next</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>].</span><span class=nf>AddError</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=nx>handler</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>})</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>chain</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>checkRecursion</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>currentStack</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=nx>middlewareStackKey</span><span class=p>).([]</span><span class=kt>string</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>currentStack</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=kt>string</span><span class=p>{}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nf>inSlice</span><span class=p>(</span><span class=nx>middlewareName</span><span class=p>,</span><span class=w> </span><span class=nx>currentStack</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not instantiate middleware %s: recursion detected in %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>,</span><span class=w> </span><span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>currentStack</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>),</span><span class=w> </span><span class=s>&#34;-&gt;&#34;</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareStackKey</span><span class=p>,</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>currentStack</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>)),</span><span class=w> </span><span class=kc>nil</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=c1>// it is the responsibility of the caller to make sure that b.configs[middlewareName].Middleware exists.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>b</span><span class=w> </span><span class=o>*</span><span class=nx>Builder</span><span class=p>)</span><span class=w> </span><span class=nf>buildConstructor</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>alice</span><span class=p>.</span><span class=nx>Constructor</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>config</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>b</span><span class=p>.</span><span class=nx>configs</span><span class=p>[</span><span class=nx>middlewareName</span><span class=p>]</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>config</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>Middleware</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid middleware %q configuration&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>var</span><span class=w> </span><span class=nx>middleware</span><span class=w> </span><span class=nx>alice</span><span class=p>.</span><span class=nx>Constructor</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>badConf</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;cannot create middleware: multi-types middleware not supported, consider declaring two different pieces of middleware instead&#34;</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// Chain  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>Chain</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nx>middleware</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>badConf</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>qualifiedNames</span><span class=w> </span><span class=p>[]</span><span class=kt>string</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>name</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>Chain</span><span class=p>.</span><span class=nx>Middlewares</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nx>qualifiedNames</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>qualifiedNames</span><span class=p>,</span><span class=w> </span><span class=nx>provider</span><span class=p>.</span><span class=nf>GetQualifiedName</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>name</span><span class=p>))</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>config</span><span class=p>.</span><span class=nx>Chain</span><span class=p>.</span><span class=nx>Middlewares</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>qualifiedNames</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nx>middleware</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>next</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=nx>chain</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>next</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>Chain</span><span class=p>,</span><span class=w> </span><span class=nx>b</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=nx>middleware</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid middleware %q configuration: invalid middleware type or middleware does not exist&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>middlewareName</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// The tracing middleware is a NOOP if tracing is not setup on the middleware chain.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// Hence, regarding internal resources&#39; observability deactivation,   // this would not enable tracing.   return tracing.WrapMiddleware(ctx, middleware), nil  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>此函数遍历中间件名称以构建构造函数链。每个构造函数负责创建一个中间件实例，并将其与链中的下一个处理程序集成。</p><p>buildConstructor 函数根据其配置为特定中间件创建构造函数，应用反射来识别中间件类型并实例化相关函数。</p><p>这种方法使 Traefik 能够支持具有不同配置的各种中间件，同时促进结构良好且模块化的代码库。</p><h3 id=结论>结论<a hidden class=anchor aria-hidden=true href=#结论>#</a></h3></div><footer class=post-footer><ul class=post-tags><li><a href=https://zhoukuncheng.github.io/zh/tags/golang/>Golang</a></li><li><a href=https://zhoukuncheng.github.io/zh/tags/traefik/>Traefik</a></li></ul></footer><script src=https://giscus.app/client.js data-repo=zhoukuncheng/zhoukuncheng.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyODIxMTA1OTU=" data-category=General data-category-id=DIC_kwDOENCqg84Cexta data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=purple_dark data-lang=en crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2026 <a href=https://zhoukuncheng.github.io/zh/>zhoukuncheng's Personal Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>